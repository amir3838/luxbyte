<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار الكاميرا - LUXBYTE</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container" style="max-width: 800px; margin: 50px auto; padding: 20px;">
        <div class="card">
            <h1 style="text-align: center; margin-bottom: 30px; color: var(--text-primary);">
                <i class="fas fa-camera" style="margin-left: 10px;"></i>
                اختبار نظام الكاميرا المحسّن
            </h1>

            <div style="text-align: center; margin-bottom: 30px;">
                <button id="btnOpenCam" class="btn" style="margin: 10px;">
                    <i class="fas fa-camera"></i>
                    فتح الكاميرا
                </button>
                <button id="btnShot" class="btn" style="margin: 10px;">
                    <i class="fas fa-camera-retro"></i>
                    التقاط صورة
                </button>
                <button id="btnStop" class="btn btn-outline" style="margin: 10px;">
                    <i class="fas fa-stop"></i>
                    إيقاف الكاميرا
                </button>
            </div>

            <div style="text-align: center; margin: 20px 0;">
                <video id="camPrev" playsinline style="width: 400px; height: 300px; border-radius: 8px; background: #000; display: none; margin: 0 auto;"></video>
            </div>

            <div style="text-align: center; margin: 20px 0;">
                <input id="fileFallback" type="file" accept="image/*" capture="environment" style="display: none;">
                <button id="btnFile" class="btn btn-secondary" style="margin: 10px;">
                    <i class="fas fa-file-image"></i>
                    اختيار ملف
                </button>
            </div>

            <div id="status" style="text-align: center; margin: 20px 0; padding: 15px; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border-color);">
                <p style="margin: 0; color: var(--text-muted);">جاهز للاختبار</p>
            </div>

            <div id="preview" style="text-align: center; margin: 20px 0;"></div>
        </div>
    </div>

    <script type="module">
        import { openCameraOnce, captureAndUpload, onFallbackFile, stopStream } from './js/file-upload-manager.js';

        // عناصر DOM
        const openBtn = document.getElementById('btnOpenCam');
        const shotBtn = document.getElementById('btnShot');
        const stopBtn = document.getElementById('btnStop');
        const fileBtn = document.getElementById('btnFile');
        const fallback = document.getElementById('fileFallback');
        const status = document.getElementById('status');
        const preview = document.getElementById('preview');

        // تحديث حالة النظام
        function updateStatus(message, type = 'info') {
            status.innerHTML = `<p style="margin: 0; color: ${type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : 'var(--text-muted)'};">${message}</p>`;
        }

        // فتح الكاميرا
        openBtn.addEventListener('click', async () => {
            updateStatus('جاري فتح الكاميرا...', 'info');
            try {
                await openCameraOnce();
                updateStatus('تم فتح الكاميرا بنجاح ✅', 'success');
            } catch (error) {
                updateStatus(`خطأ: ${error.message}`, 'error');
            }
        });

        // التقاط صورة
        shotBtn.addEventListener('click', async () => {
            updateStatus('جاري التقاط الصورة...', 'info');
            try {
                const result = await captureAndUpload();
                if (result) {
                    updateStatus('تم التقاط الصورة بنجاح ✅', 'success');
                } else {
                    updateStatus('فشل في التقاط الصورة', 'error');
                }
            } catch (error) {
                updateStatus(`خطأ: ${error.message}`, 'error');
            }
        });

        // إيقاف الكاميرا
        stopBtn.addEventListener('click', () => {
            stopStream();
            updateStatus('تم إيقاف الكاميرا', 'info');
        });

        // اختيار ملف
        fileBtn.addEventListener('click', () => {
            fallback.click();
        });

        // معالجة اختيار الملف
        fallback.addEventListener('change', async (e) => {
            updateStatus('جاري معالجة الملف...', 'info');
            try {
                await onFallbackFile(e);
                updateStatus('تم رفع الملف بنجاح ✅', 'success');
            } catch (error) {
                updateStatus(`خطأ: ${error.message}`, 'error');
            }
        });

        // فحص دعم الكاميرا
        function checkCameraSupport() {
            const isSecure = window.isSecureContext || location.hostname === 'localhost';
            const supports = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
            const isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

            let message = '';
            if (!isSecure) {
                message = '⚠️ يجب فتح الموقع عبر HTTPS أو localhost';
            } else if (!supports) {
                message = '⚠️ المتصفح لا يدعم الكاميرا';
            } else if (isiOS) {
                message = 'ℹ️ على iOS سيتم استخدام اختيار الملفات';
            } else {
                message = '✅ الكاميرا مدعومة وجاهزة للاستخدام';
            }

            updateStatus(message, isSecure && supports ? 'success' : 'info');
        }

        // تهيئة الصفحة
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🎥 Camera test page loaded');
            checkCameraSupport();
        });
    </script>
</body>
</html>
