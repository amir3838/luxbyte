<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ - LUXBYTE</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container" style="max-width: 800px; margin: 50px auto; padding: 20px;">
        <div class="card">
            <h1 style="text-align: center; margin-bottom: 30px; color: var(--text-primary);">
                <i class="fas fa-camera" style="margin-left: 10px;"></i>
                Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù…Ø­Ø³Ù‘Ù†
            </h1>

            <div style="text-align: center; margin-bottom: 30px;">
                <button id="btnOpenCam" class="btn" style="margin: 10px;">
                    <i class="fas fa-camera"></i>
                    ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                </button>
                <button id="btnShot" class="btn" style="margin: 10px;">
                    <i class="fas fa-camera-retro"></i>
                    Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø©
                </button>
                <button id="btnStop" class="btn btn-outline" style="margin: 10px;">
                    <i class="fas fa-stop"></i>
                    Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                </button>
            </div>

            <div style="text-align: center; margin: 20px 0;">
                <video id="camPrev" playsinline style="width: 400px; height: 300px; border-radius: 8px; background: #000; display: none; margin: 0 auto;"></video>
            </div>

            <div style="text-align: center; margin: 20px 0;">
                <input id="fileFallback" type="file" accept="image/*" capture="environment" style="display: none;">
                <button id="btnFile" class="btn btn-secondary" style="margin: 10px;">
                    <i class="fas fa-file-image"></i>
                    Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù
                </button>
            </div>

            <div id="status" style="text-align: center; margin: 20px 0; padding: 15px; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border-color);">
                <p style="margin: 0; color: var(--text-muted);">Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±</p>
            </div>

            <div id="preview" style="text-align: center; margin: 20px 0;"></div>
        </div>
    </div>

    <script type="module">
        import { openCameraOnce, captureAndUpload, onFallbackFile, stopStream } from './js/file-upload-manager.js';

        // Ø¹Ù†Ø§ØµØ± DOM
        const openBtn = document.getElementById('btnOpenCam');
        const shotBtn = document.getElementById('btnShot');
        const stopBtn = document.getElementById('btnStop');
        const fileBtn = document.getElementById('btnFile');
        const fallback = document.getElementById('fileFallback');
        const status = document.getElementById('status');
        const preview = document.getElementById('preview');

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
        function updateStatus(message, type = 'info') {
            status.innerHTML = `<p style="margin: 0; color: ${type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : 'var(--text-muted)'};">${message}</p>`;
        }

        // ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        openBtn.addEventListener('click', async () => {
            updateStatus('Ø¬Ø§Ø±ÙŠ ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...', 'info');
            try {
                await openCameraOnce();
                updateStatus('ØªÙ… ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');
            } catch (error) {
                updateStatus(`Ø®Ø·Ø£: ${error.message}`, 'error');
            }
        });

        // Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø©
        shotBtn.addEventListener('click', async () => {
            updateStatus('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©...', 'info');
            try {
                const result = await captureAndUpload();
                if (result) {
                    updateStatus('ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');
                } else {
                    updateStatus('ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©', 'error');
                }
            } catch (error) {
                updateStatus(`Ø®Ø·Ø£: ${error.message}`, 'error');
            }
        });

        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        stopBtn.addEventListener('click', () => {
            stopStream();
            updateStatus('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§', 'info');
        });

        // Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù
        fileBtn.addEventListener('click', () => {
            fallback.click();
        });

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù
        fallback.addEventListener('change', async (e) => {
            updateStatus('Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù...', 'info');
            try {
                await onFallbackFile(e);
                updateStatus('ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');
            } catch (error) {
                updateStatus(`Ø®Ø·Ø£: ${error.message}`, 'error');
            }
        });

        // ÙØ­Øµ Ø¯Ø¹Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        function checkCameraSupport() {
            const isSecure = window.isSecureContext || location.hostname === 'localhost';
            const supports = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
            const isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

            let message = '';
            if (!isSecure) {
                message = 'âš ï¸ ÙŠØ¬Ø¨ ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ø¨Ø± HTTPS Ø£Ùˆ localhost';
            } else if (!supports) {
                message = 'âš ï¸ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§';
            } else if (isiOS) {
                message = 'â„¹ï¸ Ø¹Ù„Ù‰ iOS Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„ÙØ§Øª';
            } else {
                message = 'âœ… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙˆØ¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…';
            }

            updateStatus(message, isSecure && supports ? 'success' : 'info');
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ¥ Camera test page loaded');
            checkCameraSupport();
        });
    </script>
</body>
</html>
