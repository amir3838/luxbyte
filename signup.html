<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - LUXBYTE</title>
    <meta name="description" content="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="/assets/app_icon/LUXBYTEICON.PNG" type="image/png">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <img src="/assets/app_icon/LUXBYTEICON.PNG" alt="LUXBYTE Logo">
                <span>LUXBYTE</span>
            </div>
            <nav class="nav">
                <a href="index.html">
                    <i class="fas fa-home"></i>
                    Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                </a>
                <a href="dashboard.html">
                    <i class="fas fa-tachometer-alt"></i>
                    Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
                </a>
                <a href="#" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                </a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <!-- Page Header -->
        <div class="card text-center mb-8" id="page-header">
            <div class="card-header" style="justify-content: center;">
                <div class="card-icon">
                    <i class="fas fa-user-plus"></i>
                </div>
                <div>
                    <h1 class="card-title" style="font-size: 32px; margin-bottom: 8px;" data-i18n="reg.title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h1>
                    <p style="color: #666; font-size: 18px;" id="page-description" data-i18n="reg.helper">Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</p>
                </div>
            </div>
        </div>

        <!-- Progress Indicator -->
        <div class="card mb-8">
            <div style="display: flex; justify-content: center; margin-bottom: 24px;">
                <div class="step active" data-step="1">
                    <i class="fas fa-user"></i>
                </div>
                <div class="step" data-step="2">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
                <div class="step" data-step="3">
                    <i class="fas fa-file-upload"></i>
                </div>
                <div class="step" data-step="4">
                    <i class="fas fa-check"></i>
                </div>
            </div>
            <div style="text-align: center;">
                <h3 id="current-step-title">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</h3>
                <p id="current-step-description" style="color: #666;">Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</p>
            </div>
        </div>

        <!-- Signup Form -->
        <div class="card">
            <form id="signupForm">
                <!-- Step 1: Personal Information -->
                <div class="step-content active" id="step-1">
                    <h3 style="margin-bottom: 24px; color: #333;">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„</label>
                            <input type="text" class="form-control" name="first_name" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø£ÙˆÙ„" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</label>
                            <input type="text" class="form-control" name="last_name" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                        <input type="email" class="form-control" name="email" placeholder="example@email.com" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                        <input type="tel" class="form-control" name="phone" placeholder="01XXXXXXXXX" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                            <input type="password" class="form-control" name="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" dir="ltr" autocomplete="new-password" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                            <input type="password" class="form-control" name="confirm_password" placeholder="Ø£ÙƒØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" dir="ltr" autocomplete="new-password" required>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Location Information -->
                <div class="step-content" id="step-2">
                    <h3 style="margin-bottom: 24px; color: #333;">Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ù„Ù†Ø´Ø§Ø·</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" data-i18n="reg.governorate">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</label>
                            <select class="form-control" name="governorate" id="governorate" required>
                                <option value="Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©" data-i18n="reg.gov.cairo">Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©</option>
                                <option value="Ø§Ù„Ø¬ÙŠØ²Ø©" data-i18n="reg.gov.giza">Ø§Ù„Ø¬ÙŠØ²Ø©</option>
                                <option value="Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©" data-i18n="reg.gov.qalyubia">Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-i18n="reg.city">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
                            <select class="form-control" name="city" id="city" required disabled>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</label>
                        <div style="display: flex; gap: 8px; align-items: flex-start;">
                            <textarea class="form-control" name="address" id="address" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù†Ùƒ Ø¨Ø§Ù„ØªÙØµÙŠÙ„" rows="3" required style="flex: 1;"></textarea>
                            <button type="button" id="getLocationBtn" class="btn btn-outline" style="padding: 12px; white-space: nowrap;" title="Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ" data-i18n="reg.get_location">
                                <i class="fas fa-map-marker-alt"></i>
                                GPS
                            </button>
                        </div>
                        <div id="locationStatus" style="margin-top: 8px; font-size: 14px; color: #666;"></div>
                    </div>

                    <!-- Dynamic Role Fields -->
                    <div id="role-fields">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Step 3: File Upload -->
                <div class="step-content" id="step-3">
                    <h3 style="margin-bottom: 24px; color: #333;">Ø±ÙØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</h3>
                    <p style="color: #666; margin-bottom: 24px;">Ø§Ø±ÙØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù†Ù‚Ø± Ø£Ùˆ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª.</p>

                    <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-info-circle" style="color: #0ea5e9; font-size: 20px;"></i>
                            <div>
                                <h4 style="margin: 0 0 4px 0; color: #0c4a6e; font-size: 16px;">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ù‡Ù…Ø©</h4>
                                <p style="margin: 0; color: #075985; font-size: 14px;">
                                    ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¶ÙˆØ­ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª ÙˆØ¬ÙˆØ¯ØªÙ‡Ø§. Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù… marked Ø¨Ù€ (*)
                                </p>
                            </div>
                        </div>
                    </div>

                    <div id="file-upload-container">
                        <!-- Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø£Ø²Ø±Ø§Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ù‡Ù†Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ -->
                    </div>
                </div>

                <!-- Step 4: Review and Submit -->
                <div class="step-content" id="step-4">
                    <h3 style="margin-bottom: 24px; color: #333;">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                    <p style="color: #666; margin-bottom: 24px;">Ø±Ø§Ø¬Ø¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</p>

                    <div id="review-data">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div style="display: flex; gap: 16px; margin-top: 32px; justify-content: space-between;">
                    <button type="button" class="btn btn-outline" id="prev-btn" onclick="prevStep()" style="display: none;">
                        <i class="fas fa-arrow-right"></i>
                        Ø§Ù„Ø³Ø§Ø¨Ù‚
                    </button>
                    <button type="button" class="btn" id="next-btn" onclick="nextStep()">
                        Ø§Ù„ØªØ§Ù„ÙŠ
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <button type="submit" class="btn" id="submit-btn" style="display: none;">
                        <i class="fas fa-check"></i>
                        Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
                    </button>
                </div>
            </form>
        </div>
    </main>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="i18n-dict.js"></script>
    <script src="js/translation-utils.js"></script>
    <script src="common.js"></script>
    <script>
        let currentStep = 1;
        let selectedRole = null;
        let uploadedFiles = {};

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸš€ Starting signup page initialization...');

            try {
            // Initialize LUXBYTE
                if (typeof LUXBYTE !== 'undefined' && LUXBYTE.init) {
            await LUXBYTE.init();
                }

            // Check if user is already logged in
            const session = await LUXBYTE.getSession();
            if (session) {
                    console.log('âœ… User already logged in, proceeding with registration');
            } else {
                    console.log('â„¹ï¸ User not logged in, will need to create account first');
            }

            injectNavbar('signup');

                // Get role from URL parameter
                selectedRole = LUXBYTE.getUrlParam('role');
                console.log('ğŸ¯ Selected role from URL:', selectedRole);
                console.log('ğŸ“‹ Available roles:', Object.keys(window.CONFIG.ROLES));

                // If no role from URL, try to get from localStorage or default
                if (!selectedRole) {
                    selectedRole = localStorage.getItem('selectedRole') || 'restaurant';
                    console.log('ğŸ”„ Using fallback role:', selectedRole);
                }

            if (!selectedRole || !window.CONFIG.ROLES[selectedRole]) {
                LUXBYTE.notifyErr('Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø· ØºÙŠØ± ØµØ­ÙŠØ­');
                window.location.href = 'choose-role.html';
                return;
            }

            // Update page header
            updatePageHeader();

            // Setup form
            setupForm();

            // Setup location dropdowns
            setupLocationDropdowns();

                // Setup GPS location
                setupGPSLocation();

                // Initialize common elements
                applyI18n();

                // Generate file upload fields immediately
                console.log('ğŸš€ Generating file upload fields immediately...');
                generateFileUploadFields();

            } catch (error) {
                console.error('âŒ Error during page initialization:', error);
                LUXBYTE.notifyErr('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.');
            }
        });

        function updatePageHeader() {
            const roleConfig = window.CONFIG.ROLES[selectedRole];
            const pageDescription = document.getElementById('page-description');
            pageDescription.textContent = `ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ${roleConfig.name}`;
        }

        function setupForm() {
            // Generate role-specific fields
            generateRoleFields();

            // Generate file upload fields only if role is selected
            if (selectedRole && window.CONFIG.ROLES[selectedRole]) {
            generateFileUploadFields();
            }
        }

        function generateRoleFields() {
            const roleConfig = window.CONFIG.ROLES[selectedRole];
            const container = document.getElementById('role-fields');

            container.innerHTML = '';

            roleConfig.fields.forEach(field => {
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'form-group';

                const label = document.createElement('label');
                label.className = 'form-label';
                label.textContent = field.label + (field.required ? ' *' : '');
                fieldDiv.appendChild(label);

                if (field.type === 'select') {
                    const select = document.createElement('select');
                    select.className = 'form-control';
                    select.name = field.name;
                    select.required = field.required;

                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = `Ø§Ø®ØªØ± ${field.label}`;
                    select.appendChild(defaultOption);

                    if (field.options) {
                        field.options.forEach(option => {
                            const optionElement = document.createElement('option');
                            optionElement.value = option;
                            optionElement.textContent = option;
                            select.appendChild(optionElement);
                        });
                    }

                    fieldDiv.appendChild(select);
                } else if (field.type === 'textarea') {
                    const textarea = document.createElement('textarea');
                    textarea.className = 'form-control';
                    textarea.name = field.name;
                    textarea.placeholder = `Ø£Ø¯Ø®Ù„ ${field.label}`;
                    textarea.required = field.required;
                    textarea.rows = 3;
                    fieldDiv.appendChild(textarea);
                } else {
                    const input = document.createElement('input');
                    input.type = field.type;
                    input.className = 'form-control';
                    input.name = field.name;
                    input.placeholder = `Ø£Ø¯Ø®Ù„ ${field.label}`;
                    input.required = field.required;
                    fieldDiv.appendChild(input);
                }

                container.appendChild(fieldDiv);
            });
        }

        function generateFileUploadFields() {
            console.log('ğŸ”§ Starting generateFileUploadFields...');
            console.log('ğŸ¯ Current selectedRole:', selectedRole);
            console.log('ğŸ“‹ Available roles:', Object.keys(window.CONFIG.ROLES));

            const roleConfig = window.CONFIG.ROLES[selectedRole];
            const container = document.getElementById('file-upload-container');

            console.log('ğŸ“Š Role config:', roleConfig);
            console.log('ğŸ“¦ Container found:', !!container);

            if (!container) {
                console.error('âŒ File upload container not found!');
                LUXBYTE.notifyErr('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ø§ÙˆÙŠØ© Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª');
                return;
            }

            // Clear container
            container.innerHTML = '';

            if (!roleConfig) {
                console.error('âŒ No role config found for:', selectedRole);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 12px;"></i>
                        <p style="font-size: 16px; margin: 0;">Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø·</p>
                    </div>
                `;
                return;
            }

            if (!roleConfig.files || roleConfig.files.length === 0) {
                console.warn('âš ï¸ No files required for role:', selectedRole);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #f59e0b;">
                        <i class="fas fa-info-circle" style="font-size: 24px; margin-bottom: 12px;"></i>
                        <p style="font-size: 16px; margin: 0;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†Ø´Ø§Ø·</p>
                    </div>
                `;
                return;
            }

            console.log('âœ… Found', roleConfig.files.length, 'files to generate');

            // Create header with instructions
            const headerDiv = document.createElement('div');
            headerDiv.style.cssText = `
                background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
                border: 1px solid #0ea5e9;
                border-radius: 12px;
                padding: 20px;
                margin-bottom: 24px;
                text-align: center;
            `;
            headerDiv.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 12px;">
                    <i class="fas fa-info-circle" style="color: #0ea5e9; font-size: 24px;"></i>
                    <h4 style="margin: 0; color: #0c4a6e; font-size: 18px;">ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª</h4>
                </div>
                <p style="margin: 0; color: #075985; font-size: 14px; line-height: 1.5;">
                    â€¢ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ù†Ø·Ù‚Ø© Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù ÙˆØ£ÙÙ„ØªÙ‡<br>
                    â€¢ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù… marked Ø¨Ù€ (*)<br>
                    â€¢ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù: 5 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª<br>
                    â€¢ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©: PDF, JPG, JPEG, PNG
                </p>
            `;
            container.appendChild(headerDiv);

            console.log('ğŸ“ Header added to container');

            // Generate file upload fields
            console.log('ğŸ”„ Starting to generate', roleConfig.files.length, 'file upload fields...');

            roleConfig.files.forEach((file, index) => {
                console.log(`ğŸ“ Creating field ${index + 1}/${roleConfig.files.length}:`, file.name);

                const fileDiv = document.createElement('div');
                fileDiv.className = 'form-group';
                fileDiv.style.cssText = 'margin-bottom: 24px;';

                const label = document.createElement('label');
                label.className = 'form-label';
                label.style.cssText = 'font-weight: 600; margin-bottom: 8px; display: block;';
                label.innerHTML = `
                    ${file.label} ${file.required ? '<span style="color: #ef4444;">*</span>' : ''}
                `;
                fileDiv.appendChild(label);

                const uploadDiv = document.createElement('div');
                uploadDiv.className = 'file-upload';
                uploadDiv.setAttribute('data-file-name', file.name);
                uploadDiv.style.cssText = `
                    border: 2px dashed #d1d5db;
                    border-radius: 12px;
                    padding: 24px;
                    text-align: center;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    background: #fafbfc;
                    position: relative;
                    overflow: hidden;
                    min-height: 120px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    gap: 12px;
                `;

                uploadDiv.innerHTML = `
                    <div class="upload-icon" style="font-size: 32px; color: #6b7280;">
                        <i class="fas fa-${file.accept.startsWith('image') ? 'image' : 'file-pdf'}"></i>
                    </div>
                    <div class="upload-text" style="font-size: 16px; font-weight: 500; color: #374151;">
                        Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ ${file.label}
                    </div>
                    <div class="upload-requirement" style="font-size: 14px; color: #6b7280; margin-top: 4px;">
                        ${file.description}
                    </div>
                    <div class="upload-button" style="
                        background: #3b82f6;
                        color: white;
                        padding: 8px 16px;
                        border-radius: 8px;
                        font-size: 14px;
                        font-weight: 500;
                        display: inline-flex;
                        align-items: center;
                        gap: 8px;
                        margin-top: 8px;
                    ">
                        <i class="fas fa-cloud-upload-alt"></i>
                        Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù
                    </div>
                    <input type="file" class="file-input" accept="${file.accept}" ${file.required ? 'required' : ''} style="display: none;">
                `;

                // Add hover effects
                uploadDiv.addEventListener('mouseenter', () => {
                    uploadDiv.style.borderColor = '#3b82f6';
                    uploadDiv.style.background = '#f0f9ff';
                    uploadDiv.style.transform = 'translateY(-2px)';
                    uploadDiv.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.15)';
                });

                uploadDiv.addEventListener('mouseleave', () => {
                    if (!uploadDiv.classList.contains('uploaded')) {
                        uploadDiv.style.borderColor = '#d1d5db';
                        uploadDiv.style.background = '#fafbfc';
                        uploadDiv.style.transform = 'translateY(0)';
                        uploadDiv.style.boxShadow = 'none';
                    }
                });

                // Click to upload
                uploadDiv.addEventListener('click', (e) => {
                    e.preventDefault();
                    const fileInput = uploadDiv.querySelector('.file-input');
                    fileInput.click();
                });

                // Drag and drop support
                uploadDiv.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadDiv.classList.add('dragover');
                    uploadDiv.style.borderColor = '#10b981';
                    uploadDiv.style.background = '#f0fdf4';
                });

                uploadDiv.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    uploadDiv.classList.remove('dragover');
                    if (!uploadDiv.classList.contains('uploaded')) {
                        uploadDiv.style.borderColor = '#d1d5db';
                        uploadDiv.style.background = '#fafbfc';
                    }
                });

                uploadDiv.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadDiv.classList.remove('dragover');
                    uploadDiv.style.borderColor = '#d1d5db';
                    uploadDiv.style.background = '#fafbfc';

                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const fileInput = uploadDiv.querySelector('.file-input');
                        fileInput.files = files;
                        handleFileUpload({ target: fileInput }, file, uploadDiv);
                    }
                });

                // File input change
                uploadDiv.querySelector('.file-input').addEventListener('change', (e) => {
                    handleFileUpload(e, file, uploadDiv);
                });

                fileDiv.appendChild(uploadDiv);
                container.appendChild(fileDiv);
            });

            console.log(`âœ… Generated ${roleConfig.files.length} file upload fields successfully`);

            // Show success message
            if (roleConfig.files.length > 0) {
                LUXBYTE.notifyOk(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${roleConfig.files.length} Ø£Ø²Ø±Ø§Ø± Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø¨Ù†Ø¬Ø§Ø­`);
                console.log('ğŸ‰ File upload fields generation completed successfully');
            }
        }

        function handleFileUpload(event, fileConfig, container) {
            const file = event.target.files[0];
            if (!file) {
                console.log('No file selected');
                return;
            }

            console.log('File selected:', { name: file.name, size: file.size, type: file.type });

            // Validate file
            if (!validateFile(file, fileConfig)) {
                LUXBYTE.notifyErr(`Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù Ø£Ùˆ Ø§Ù„Ø­Ø¬Ù… ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: 5 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª`);
                return;
            }

            // Update container appearance
            container.classList.add('uploaded');
            container.style.borderColor = '#10b981';
            container.style.background = '#f0fdf4';

            // Update text and button
            const uploadText = container.querySelector('.upload-text');
            const uploadButton = container.querySelector('.upload-button');

            if (uploadText) {
                uploadText.innerHTML = `
                    <i class="fas fa-check-circle" style="color: #10b981; margin-left: 8px;"></i>
                    ØªÙ… Ø±ÙØ¹: ${file.name}
                `;
            }

            if (uploadButton) {
                uploadButton.innerHTML = `
                    <i class="fas fa-check"></i>
                    ØªÙ… Ø§Ù„Ø±ÙØ¹
                `;
                uploadButton.style.background = '#10b981';
            }

            // Show file info
            const fileInfo = document.createElement('div');
            fileInfo.className = 'file-info';
            fileInfo.style.cssText = `
                margin-top: 12px;
                padding: 12px;
                background: rgba(16, 185, 129, 0.1);
                border-radius: 8px;
                font-size: 14px;
                color: #065f46;
            `;
            fileInfo.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span><strong>Ø§Ù„Ù…Ù„Ù:</strong> ${file.name}</span>
                    <span><strong>Ø§Ù„Ø­Ø¬Ù…:</strong> ${LUXBYTE.formatFileSize(file.size)}</span>
                </div>
                <div style="margin-top: 8px;">
                    <button type="button" onclick="removeFile('${fileConfig.name}', this)"
                            style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">
                        <i class="fas fa-trash"></i> Ø¥Ø²Ø§Ù„Ø©
                    </button>
                </div>
            `;

            // Remove existing file info if any
            const existingInfo = container.querySelector('.file-info');
            if (existingInfo) {
                existingInfo.remove();
            }

            container.appendChild(fileInfo);

            // Store file
            uploadedFiles[fileConfig.name] = file;

            console.log('File uploaded successfully:', fileConfig.name);
            LUXBYTE.notifyOk(`ØªÙ… Ø±ÙØ¹ ${fileConfig.label} Ø¨Ù†Ø¬Ø§Ø­`);
        }

        function validateFile(file, fileConfig) {
            console.log('Validating file:', { name: file.name, type: file.type, size: file.size });

            // Check file type
            if (fileConfig.accept.startsWith('image')) {
                if (!file.type.startsWith('image/')) {
                    console.log('Invalid image type:', file.type);
                    return false;
                }
            } else {
                const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
                if (!allowedTypes.includes(file.type)) {
                    console.log('Invalid file type:', file.type, 'Allowed:', allowedTypes);
                    return false;
                }
            }

            // Check file size (max 5MB)
            const maxSize = 5 * 1024 * 1024; // 5MB
            if (file.size > maxSize) {
                console.log('File too large:', file.size, 'Max:', maxSize);
                return false;
            }

            console.log('File validation passed');
            return true;
        }

        function removeFile(fileName, buttonElement) {
            console.log('Removing file:', fileName);

            // Remove from uploaded files
            delete uploadedFiles[fileName];

            // Find the container
            const container = buttonElement.closest('.file-upload');
            if (container) {
                // Reset container appearance
                container.classList.remove('uploaded');
                container.style.borderColor = '#d1d5db';
                container.style.background = '#fafbfc';

                // Reset text and button
                const uploadText = container.querySelector('.upload-text');
                const uploadButton = container.querySelector('.upload-button');

                if (uploadText) {
                    uploadText.innerHTML = `Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ ${fileName}`;
                }

                if (uploadButton) {
                    uploadButton.innerHTML = `
                        <i class="fas fa-cloud-upload-alt"></i>
                        Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù
                    `;
                    uploadButton.style.background = '#3b82f6';
                }

                // Remove file info
                const fileInfo = container.querySelector('.file-info');
                if (fileInfo) {
                    fileInfo.remove();
                }

                // Reset file input
                const fileInput = container.querySelector('.file-input');
                if (fileInput) {
                    fileInput.value = '';
                }
            }

            LUXBYTE.notifyOk('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù');
        }

        function showFilePreview(file, container) {
            container.innerHTML = '';

            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.className = 'file-preview';
                img.style.width = '100%';
                img.style.height = '120px';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '8px';
                container.appendChild(img);
            } else {
                const icon = document.createElement('div');
                icon.className = 'upload-icon';
                icon.innerHTML = '<i class="fas fa-file"></i>';
                container.appendChild(icon);
            }

            const info = document.createElement('div');
            info.className = 'file-info';
            info.innerHTML = `
                <div class="file-name">${file.name}</div>
                <div class="file-size">${LUXBYTE.formatFileSize(file.size)}</div>
            `;
            container.appendChild(info);

            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-file';
            removeBtn.innerHTML = '<i class="fas fa-trash"></i> Ø¥Ø²Ø§Ù„Ø©';
            removeBtn.onclick = () => {
                container.innerHTML = '';
                generateFileUploadFields();
                delete uploadedFiles[file.name];
            };
            container.appendChild(removeBtn);
        }

        function setupLocationDropdowns() {
            const governorateSelect = document.getElementById('governorate');
            const citySelect = document.getElementById('city');

            // Set default governorate to first option (Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©)
            governorateSelect.value = 'Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©';
            LUXBYTE.updateCityDropdown(governorateSelect, citySelect);

            governorateSelect.addEventListener('change', () => {
                LUXBYTE.updateCityDropdown(governorateSelect, citySelect);
            });
        }

        function setupGPSLocation() {
            console.log('ğŸ—ºï¸ Setting up GPS location...');

            const getLocationBtn = document.getElementById('getLocationBtn');
            const addressField = document.getElementById('address');
            const locationStatus = document.getElementById('locationStatus');

            console.log('ğŸ” GPS Elements found:', {
                getLocationBtn: !!getLocationBtn,
                addressField: !!addressField,
                locationStatus: !!locationStatus
            });

            if (!getLocationBtn) {
                console.error('âŒ GPS button not found!');
                LUXBYTE.notifyErr('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ');
                return;
            }

            console.log('âœ… GPS button found, setting up event listener...');

            getLocationBtn.addEventListener('click', async () => {
                console.log('GPS button clicked!');

                // Check if geolocation is supported
                if (!navigator.geolocation) {
                    locationStatus.innerHTML = '<span style="color: #ef4444;"><i class="fas fa-exclamation-triangle"></i> Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS</span>';
                    LUXBYTE.notifyErr('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS');
                    return;
                }

                // Show loading state
                locationStatus.innerHTML = '<span style="color: #6b7280;"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹...</span>';
                getLocationBtn.disabled = true;
                getLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ...';

                try {
                    // Request location with better options
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 15000,
                            maximumAge: 300000 // 5 minutes
                        });
                    });

                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;

                    console.log('Location obtained:', { lat, lng });

                    // Get address from coordinates
                    await getAddressFromCoordinates(lat, lng);

                    // Show success message
                        locationStatus.innerHTML = `<span style="color: #10b981;"><i class="fas fa-check"></i> ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${lat.toFixed(6)}, ${lng.toFixed(6)}</span>`;
                    LUXBYTE.notifyOk('ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­');

                } catch (error) {
                    console.error('GPS Error:', error);

                        let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
                    let errorIcon = 'fas fa-exclamation-triangle';

                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                            errorMessage = 'ØªÙ… Ø±ÙØ¶ Ø¥Ø°Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­';
                            errorIcon = 'fas fa-ban';
                                break;
                            case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ GPS';
                            errorIcon = 'fas fa-map-marker-slash';
                                break;
                            case error.TIMEOUT:
                            errorMessage = 'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø·Ù„Ø¨. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
                            errorIcon = 'fas fa-clock';
                                break;
                        }

                    locationStatus.innerHTML = `<span style="color: #ef4444;"><i class="${errorIcon}"></i> ${errorMessage}</span>`;
                    LUXBYTE.notifyErr(errorMessage);
                } finally {
                    // Reset button state
                        getLocationBtn.disabled = false;
                    getLocationBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i> GPS';
                }
            });
        }

        async function getAddressFromCoordinates(lat, lng) {
            try {
                console.log('Getting address for coordinates:', { lat, lng });

            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Nominatim API Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ar&addressdetails=1`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Address data received:', data);

                    if (data && data.display_name) {
                        const address = data.display_name;
                    const addressField = document.getElementById('address');
                    if (addressField) {
                        addressField.value = address;
                        console.log('Address set successfully:', address);
                    }
                } else {
                    console.warn('No address data received from Nominatim');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:', error);
                // Don't show error to user as GPS still worked
            }
        }

        function nextStep() {
            console.log('â¡ï¸ Moving to next step from step', currentStep);

            if (currentStep < 4) {
                if (validateCurrentStep()) {
                    currentStep++;
                    console.log('âœ… Step validation passed, moving to step', currentStep);
                    updateStepDisplay();

                    // Regenerate file upload fields when reaching step 3
                    if (currentStep === 3) {
                        console.log('ğŸ“ Reached step 3, generating file upload fields...');
                        if (selectedRole && window.CONFIG.ROLES[selectedRole]) {
                            // Add a small delay to ensure DOM is ready
                            setTimeout(() => {
                                generateFileUploadFields();
                            }, 100);
                        } else {
                            console.error('âŒ Cannot generate file upload fields - missing role config');
                            LUXBYTE.notifyErr('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø·');
                        }
                    }
                } else {
                    console.log('âŒ Step validation failed');
                }
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepDisplay();
            }
        }

        function validateCurrentStep() {
            const currentStepElement = document.getElementById(`step-${currentStep}`);
            const requiredFields = currentStepElement.querySelectorAll('[required]');

            console.log('Validating step:', currentStep);

            // Validate required form fields
            for (const field of requiredFields) {
                if (!field.value || !field.value.trim()) {
                    const fieldLabel = field.previousElementSibling?.textContent || field.getAttribute('name') || 'Ø­Ù‚Ù„';
                    LUXBYTE.notifyErr(`ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ ${fieldLabel}`);
                    field.focus();
                    return false;
                }
            }

            // Special validation for step 3 (files)
            if (currentStep === 3) {
                const roleConfig = window.CONFIG.ROLES[selectedRole];
                if (roleConfig && roleConfig.files) {
                const requiredFiles = roleConfig.files.filter(f => f.required);
                    console.log('Required files:', requiredFiles.map(f => f.name));
                    console.log('Uploaded files:', Object.keys(uploadedFiles));

                for (const file of requiredFiles) {
                    if (!uploadedFiles[file.name]) {
                        LUXBYTE.notifyErr(`ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${file.label}`);

                            // Scroll to the file upload section
                            const fileContainer = document.getElementById('file-upload-container');
                            if (fileContainer) {
                                fileContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }

                        return false;
                        }
                    }
                }
            }

            // Special validation for step 2 (location)
            if (currentStep === 2) {
                const addressField = document.getElementById('address');
                if (addressField && !addressField.value.trim()) {
                    LUXBYTE.notifyErr('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ');
                    addressField.focus();
                    return false;
                }
            }

            console.log('Step validation passed');
            return true;
        }

        function updateStepDisplay() {
            // Update step indicators
            document.querySelectorAll('.step').forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index + 1 < currentStep) {
                    step.classList.add('completed');
                } else if (index + 1 === currentStep) {
                    step.classList.add('active');
                }
            });

            // Update step content
            document.querySelectorAll('.step-content').forEach((content, index) => {
                content.classList.remove('active');
                if (index + 1 === currentStep) {
                    content.classList.add('active');
                }
            });

            // Update step title and description
            const titles = [
                'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©',
                'Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ù„Ù†Ø´Ø§Ø·',
                'Ø±ÙØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª',
                'Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'
            ];

            const descriptions = [
                'Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©',
                'Ø§Ø®ØªØ± Ù…ÙˆÙ‚Ø¹Ùƒ ÙˆÙ†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·',
                'Ø§Ø±ÙØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©',
                'Ø±Ø§Ø¬Ø¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„'
            ];

            document.getElementById('current-step-title').textContent = titles[currentStep - 1];
            document.getElementById('current-step-description').textContent = descriptions[currentStep - 1];

            // Update navigation buttons
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const submitBtn = document.getElementById('submit-btn');

            prevBtn.style.display = currentStep > 1 ? 'block' : 'none';

            if (currentStep === 4) {
                nextBtn.style.display = 'none';
                submitBtn.style.display = 'block';
                generateReviewData();
            } else {
                nextBtn.style.display = 'block';
                submitBtn.style.display = 'none';
            }
        }

        function generateReviewData() {
            const formData = new FormData(document.getElementById('signupForm'));
            const reviewContainer = document.getElementById('review-data');

            reviewContainer.innerHTML = '';

            // Personal info
            const personalDiv = document.createElement('div');
            personalDiv.innerHTML = `
                <h4 style="color: #333; margin-bottom: 12px;">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</h4>
                <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${formData.get('first_name')} ${formData.get('last_name')}</p>
                <p><strong>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong> ${formData.get('email')}</p>
                <p><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${formData.get('phone')}</p>
            `;
            reviewContainer.appendChild(personalDiv);

            // Location
            const locationDiv = document.createElement('div');
            locationDiv.innerHTML = `
                <h4 style="color: #333; margin-bottom: 12px; margin-top: 20px;">Ø§Ù„Ù…ÙˆÙ‚Ø¹</h4>
                <p><strong>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</strong> ${formData.get('governorate')}</p>
                <p><strong>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</strong> ${formData.get('city')}</p>
                <p><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${formData.get('address')}</p>
            `;
            reviewContainer.appendChild(locationDiv);

            // Role-specific fields
            const roleConfig = window.CONFIG.ROLES[selectedRole];
            const roleDiv = document.createElement('div');
            roleDiv.innerHTML = `<h4 style="color: #333; margin-bottom: 12px; margin-top: 20px;">Ø¨ÙŠØ§Ù†Ø§Øª ${roleConfig.name}</h4>`;

            roleConfig.fields.forEach(field => {
                const value = formData.get(field.name);
                if (value) {
                    const p = document.createElement('p');
                    p.innerHTML = `<strong>${field.label}:</strong> ${value}`;
                    roleDiv.appendChild(p);
                }
            });
            reviewContainer.appendChild(roleDiv);

            // Files
            const filesDiv = document.createElement('div');
            filesDiv.innerHTML = `<h4 style="color: #333; margin-bottom: 12px; margin-top: 20px;">Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©</h4>`;

            Object.keys(uploadedFiles).forEach(fileName => {
                const file = uploadedFiles[fileName];
                const p = document.createElement('p');
                p.innerHTML = `<strong>${fileName}:</strong> ${file.name} (${LUXBYTE.formatFileSize(file.size)})`;
                filesDiv.appendChild(p);
            });
            reviewContainer.appendChild(filesDiv);
        }

        // Form submission
        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            await withLoader(async () => {
                // Check if user is logged in, if not create account first
                let session = await LUXBYTE.getSession();
                if (!session) {
                    // Create account first
                    const formData = new FormData(e.target);
                    const email = formData.get('email');
                    const password = (formData.get('password') ?? '').toString();
                    const confirmPassword = (formData.get('confirm_password') ?? '').toString();

                    // ØªØ´Ø®ÙŠØµ Ø³Ø±ÙŠØ¹ (ÙŠÙ…ÙƒÙ† Ø­Ø°ÙÙ‡ ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬)
                    console.debug('Password validation debug:', {
                        password, confirmPassword,
                        len1: password.length, len2: confirmPassword.length,
                        codes1: [...password].map(c => c.charCodeAt(0)),
                        codes2: [...confirmPassword].map(c => c.charCodeAt(0)),
                    });

                    // ØªÙ†Ø¸ÙŠÙ Ù…Ø­Ø§Ø±Ù Ø§Ù„Ø§ØªØ¬Ø§Ù‡ ØºÙŠØ± Ø§Ù„Ù…Ø±Ø¦ÙŠØ©
                    const stripBidi = (s) => s.replace(/[\u200E\u200F\u061C]/g, '').normalize('NFC');
                    const passwordClean = stripBidi(password);
                    const confirmClean = stripBidi(confirmPassword);

                    if (!passwordClean || !confirmClean) {
                        throw new Error('Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØ§Ù„ØªØ£ÙƒÙŠØ¯');
                    }

                    if (passwordClean !== confirmClean) {
                        throw new Error('ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©');
                    }

                    const { data: authData, error: authError } = await LUXBYTE.supabase.auth.signUp({
                        email: email,
                        password: passwordClean
                    });

                    if (authError) {
                        throw authError;
                    }

                    // Wait a moment for the session to be established
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    session = await LUXBYTE.getSession();
                }

                // Upload files
                const fileUrls = {};
                const roleConfig = window.CONFIG.ROLES[selectedRole];

                for (const [fileName, file] of Object.entries(uploadedFiles)) {
                    const url = await LUXBYTE.uploadToBucket(roleConfig.bucket, fileName, file);
                    fileUrls[fileName] = url;
                }

                // Prepare data for database
                const formData = new FormData(e.target);
                const data = {};

                // Add form fields
                for (let [key, value] of formData.entries()) {
                    data[key] = value;
                }

                // Add file URLs
                Object.assign(data, fileUrls);

                // Add metadata
                data.role = selectedRole;
                data.created_at = new Date().toISOString();
                data.status = 'pending';
                data.user_id = session.user.id;

                // Insert into database
                const { data: result, error } = await LUXBYTE.supabase
                    .from(roleConfig.table)
                    .insert([data]);

                if (error) {
                    throw error;
                }

                return result;
            }, 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡ Ù‚Ø±ÙŠØ¨Ø§Ù‹');

            setTimeout(() => {
                window.location.href = 'index.html';
            }, 2000);
        });


        // Logout function
        async function logout() {
            try {
                await LUXBYTE.supabase.auth.signOut();
                LUXBYTE.notifyOk('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­');
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Logout error:', error);
                LUXBYTE.notifyErr('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
            }
        }
    </script>

    <!-- Ticker Marquee -->
    <div class="ticker" role="status" aria-live="polite">
        <div class="ticker__track">
            ğŸš€ Ø¨Ø« ØªØ¬Ø±ÙŠØ¨ÙŠ Ø­ÙŠ ğŸš€ â€” Ù„Ø§ ØªØªØ±Ø¯Ø¯ ÙÙŠ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ ÙÙŠ Ø­Ø§Ù„ Ø¸Ù‡ÙˆØ± Ø£ÙŠ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ â€” Ù„ÙˆÙƒØ³ Ø¨Ø§ÙŠØª (Ù‡Ù†ÙƒØ¨Ø± Ù…Ø¹ Ø¨Ø¹Ø¶) â€” Ù…Ù†ØµØ© Ø´ÙˆØ¨ Ø¥ÙŠ Ø¬ÙŠ Ùˆ Ù…Ø§Ø³ØªØ± Ø¯Ø±Ø§ÙŠÙØ± â€” Ø§Ù„ØªØ¬Ø§Ø±Ø© Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© ÙˆØ®Ø¯Ù…Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„ â€” Ø§Ù†Ø¶Ù… Ø¥Ù„ÙŠÙ†Ø§ Ø§Ù„Ø¢Ù† â€” ğŸ“ 01148709609 â€” ğŸŒ www.luxbyte.com
        </div>
    </div>
</body>
</html>
