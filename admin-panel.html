<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة الإدارة - LUXBYTE</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="css/themes.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="assets/app_icon/LUXBYTEICON.PNG" type="image/png">
</head>
<body>
    <div class="container" style="max-width: 1200px; margin: 20px auto; padding: 20px;">
        <div class="card">
            <div class="text-center mb-8">
                <img src="assets/app_icon/LUXBYTEICON.PNG" alt="LUXBYTE" style="width: 60px; height: 60px; margin-bottom: 16px;">
                <h1 style="color: var(--text-primary); margin-bottom: 8px;">لوحة الإدارة</h1>
                <p style="color: var(--text-muted);">إدارة المستخدمين وأنواع الحسابات</p>
            </div>

            <!-- Admin Key Input -->
            <div class="form-group mb-4">
                <label class="form-label">مفتاح الإدارة</label>
                <input type="password" id="adminKey" class="form-control" placeholder="أدخل مفتاح الإدارة" required>
                <small style="color: var(--text-muted); font-size: 12px;">
                    <i class="fas fa-shield-alt"></i>
                    هذا المفتاح مطلوب للوصول إلى لوحة الإدارة
                </small>
                <button id="connectBtn" class="btn" style="margin-top: 8px;">
                    <i class="fas fa-key"></i>
                    الاتصال
                </button>
            </div>

            <!-- Security Notice -->
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                <i class="fas fa-exclamation-triangle" style="color: #856404; margin-left: 8px;"></i>
                <strong style="color: #856404;">تنبيه أمني:</strong>
                <span style="color: #856404;">هذه الصفحة محمية. لا تشارك مفتاح الإدارة مع أي شخص.</span>
            </div>

            <!-- Stats Cards -->
            <div id="statsContainer" style="display: none;">
                <h3 style="margin-bottom: 16px;">إحصائيات المستخدمين</h3>
                <div id="statsCards" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;"></div>
            </div>

            <!-- Users Table -->
            <div id="usersContainer" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3>قائمة المستخدمين</h3>
                    <button id="refreshBtn" class="btn btn-outline">
                        <i class="fas fa-refresh"></i>
                        تحديث
                    </button>
                </div>

                <div class="table-responsive" style="overflow-x: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>البريد الإلكتروني</th>
                                <th>نوع الحساب</th>
                                <th>المدينة</th>
                                <th>تاريخ الإنشاء</th>
                                <th>آخر دخول</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div id="pagination" style="display: flex; justify-content: center; align-items: center; gap: 16px; margin-top: 20px;">
                    <!-- Pagination will be loaded here -->
                </div>
            </div>

            <!-- Change Account Type Modal -->
            <div id="changeAccountModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 24px; border-radius: 12px; min-width: 400px;">
                    <h3 style="margin-bottom: 16px;">تغيير نوع الحساب</h3>
                    <div class="form-group">
                        <label class="form-label">المستخدم</label>
                        <input type="text" id="modalUserEmail" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">نوع الحساب الجديد</label>
                        <select id="modalNewAccountType" class="form-control">
                            <option value="pharmacy">صيدلية</option>
                            <option value="supermarket">سوبرماركت</option>
                            <option value="restaurant">مطعم</option>
                            <option value="clinic">عيادة</option>
                            <option value="courier">مندوب توصيل</option>
                            <option value="driver">سائق</option>
                            <option value="admin">مدير</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
                        <button id="cancelChangeBtn" class="btn btn-outline">إلغاء</button>
                        <button id="confirmChangeBtn" class="btn">تأكيد التغيير</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let adminKey = '';
        let currentPage = 1;
        let currentUserId = '';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Admin Panel Loaded');

            // Event listeners
            document.getElementById('connectBtn').addEventListener('click', connect);
            document.getElementById('refreshBtn').addEventListener('click', loadUsers);
            document.getElementById('cancelChangeBtn').addEventListener('click', hideModal);
            document.getElementById('confirmChangeBtn').addEventListener('click', confirmChange);
        });

        async function connect() {
            adminKey = document.getElementById('adminKey').value;
            if (!adminKey) {
                alert('يرجى إدخال مفتاح الإدارة');
                return;
            }

            try {
                await loadUsers();
                document.getElementById('statsContainer').style.display = 'block';
                document.getElementById('usersContainer').style.display = 'block';
                document.getElementById('connectBtn').innerHTML = '<i class="fas fa-check"></i> متصل';
                document.getElementById('connectBtn').disabled = true;
            } catch (error) {
                console.error('Connection error:', error);
                alert('فشل في الاتصال: ' + error.message);
            }
        }

        async function loadUsers(page = 1) {
            try {
                const response = await fetch(`/api/list-users?page=${page}&limit=10&admin_key=${adminKey}`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error);
                }

                displayUsers(data.data.users);
                displayStats(data.data.stats);
                displayPagination(data.data.pagination);
                currentPage = page;

            } catch (error) {
                console.error('Load users error:', error);
                alert('فشل في تحميل المستخدمين: ' + error.message);
            }
        }

        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.user.email}</td>
                    <td>
                        <span class="badge" style="background: #6b7cff; color: white; padding: 4px 8px; border-radius: 4px;">
                            ${getAccountTypeLabel(user.account)}
                        </span>
                    </td>
                    <td>${user.city || '-'}</td>
                    <td>${formatDate(user.created_at)}</td>
                    <td>${user.user.last_sign_in_at ? formatDate(user.user.last_sign_in_at) : 'لم يسجل دخول'}</td>
                    <td>
                        <button class="btn btn-outline" onclick="showChangeModal('${user.user.id}', '${user.user.email}', '${user.account}')">
                            <i class="fas fa-edit"></i>
                            تغيير النوع
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function displayStats(stats) {
            const container = document.getElementById('statsCards');
            container.innerHTML = '';

            const accountTypes = {
                pharmacy: 'صيدلية',
                supermarket: 'سوبرماركت',
                restaurant: 'مطعم',
                clinic: 'عيادة',
                courier: 'مندوب',
                driver: 'سائق',
                admin: 'مدير'
            };

            Object.entries(stats).forEach(([type, count]) => {
                const card = document.createElement('div');
                card.className = 'card text-center';
                card.innerHTML = `
                    <h4 style="color: #6b7cff; margin-bottom: 8px;">${count}</h4>
                    <p style="color: var(--text-muted); margin: 0;">${accountTypes[type] || type}</p>
                `;
                container.appendChild(card);
            });
        }

        function displayPagination(pagination) {
            const container = document.getElementById('pagination');
            container.innerHTML = '';

            if (pagination.pages <= 1) return;

            // Previous button
            if (pagination.page > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.className = 'btn btn-outline';
                prevBtn.innerHTML = '<i class="fas fa-chevron-right"></i> السابق';
                prevBtn.addEventListener('click', () => loadUsers(pagination.page - 1));
                container.appendChild(prevBtn);
            }

            // Page numbers
            for (let i = 1; i <= pagination.pages; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `btn ${i === pagination.page ? '' : 'btn-outline'}`;
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', () => loadUsers(i));
                container.appendChild(pageBtn);
            }

            // Next button
            if (pagination.page < pagination.pages) {
                const nextBtn = document.createElement('button');
                nextBtn.className = 'btn btn-outline';
                nextBtn.innerHTML = 'التالي <i class="fas fa-chevron-left"></i>';
                nextBtn.addEventListener('click', () => loadUsers(pagination.page + 1));
                container.appendChild(nextBtn);
            }
        }

        function showChangeModal(userId, userEmail, currentType) {
            currentUserId = userId;
            document.getElementById('modalUserEmail').value = userEmail;
            document.getElementById('modalNewAccountType').value = currentType;
            document.getElementById('changeAccountModal').style.display = 'block';
        }

        function hideModal() {
            document.getElementById('changeAccountModal').style.display = 'none';
        }

        async function confirmChange() {
            const newType = document.getElementById('modalNewAccountType').value;

            if (!newType) {
                alert('يرجى اختيار نوع الحساب الجديد');
                return;
            }

            try {
                const response = await fetch('/api/change-account-type', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: currentUserId,
                        new_account_type: newType,
                        admin_key: adminKey
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error);
                }

                alert('تم تغيير نوع الحساب بنجاح');
                hideModal();
                loadUsers(currentPage);

            } catch (error) {
                console.error('Change account type error:', error);
                alert('فشل في تغيير نوع الحساب: ' + error.message);
            }
        }

        function getAccountTypeLabel(type) {
            const labels = {
                pharmacy: 'صيدلية',
                supermarket: 'سوبرماركت',
                restaurant: 'مطعم',
                clinic: 'عيادة',
                courier: 'مندوب',
                driver: 'سائق',
                admin: 'مدير'
            };
            return labels[type] || type;
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('ar-EG');
        }
    </script>

    <!-- Guard Scripts -->
    <script type="module" src="js/guard.js"></script>
    <script type="module" src="js/supabase-client.js"></script>
</body>
</html>
