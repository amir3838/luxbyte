<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار نظام رفع الملفات - LUXBYTE</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container" style="max-width: 800px; margin: 50px auto; padding: 20px;">
        <h1>اختبار نظام رفع الملفات</h1>
        
        <div class="card">
            <h2>اختبار رفع الملفات</h2>
            
            <div id="test-results" style="margin-bottom: 20px;">
                <h3>نتائج الاختبار:</h3>
                <ul id="test-list"></ul>
            </div>
            
            <div id="file-upload-container">
                <div style="text-align: center; padding: 40px; color: #666;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 12px;"></i>
                    <p>جاري تحميل نظام رفع الملفات...</p>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <button onclick="testCameraFunctionality()" class="btn btn-primary">
                    <i class="fas fa-camera"></i>
                    اختبار الكاميرا
                </button>
                <button onclick="testFileSelection()" class="btn btn-secondary">
                    <i class="fas fa-file"></i>
                    اختبار اختيار الملف
                </button>
                <button onclick="clearTestResults()" class="btn btn-outline">
                    <i class="fas fa-trash"></i>
                    مسح النتائج
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/file-upload-manager.js"></script>
    
    <script>
        let testResults = [];
        
        function addTestResult(test, status, message) {
            const result = {
                test: test,
                status: status,
                message: message,
                timestamp: new Date().toLocaleString()
            };
            testResults.push(result);
            updateTestDisplay();
        }
        
        function updateTestDisplay() {
            const list = document.getElementById('test-list');
            list.innerHTML = '';
            
            testResults.forEach(result => {
                const li = document.createElement('li');
                li.style.cssText = `
                    padding: 10px;
                    margin: 5px 0;
                    border-radius: 5px;
                    background: ${result.status === 'success' ? '#d4edda' : result.status === 'error' ? '#f8d7da' : '#fff3cd'};
                    color: ${result.status === 'success' ? '#155724' : result.status === 'error' ? '#721c24' : '#856404'};
                `;
                li.innerHTML = `
                    <strong>${result.test}:</strong> ${result.message}
                    <br><small>${result.timestamp}</small>
                `;
                list.appendChild(li);
            });
        }
        
        function clearTestResults() {
            testResults = [];
            updateTestDisplay();
        }
        
        function testCameraFunctionality() {
            addTestResult('اختبار الكاميرا', 'info', 'بدء اختبار الكاميرا...');
            
            if (typeof window.openCameraOrFile === 'function') {
                addTestResult('دالة الكاميرا', 'success', 'دالة openCameraOrFile متاحة');
                
                // Test camera support
                const isSupported = checkCameraSupport();
                addTestResult('دعم الكاميرا', isSupported ? 'success' : 'warning', 
                    isSupported ? 'الكاميرا مدعومة' : 'الكاميرا غير مدعومة');
                
                // Test camera access
                if (isSupported) {
                    openCameraOrFile('test_document', 'image/*')
                        .then(() => {
                            addTestResult('فتح الكاميرا', 'success', 'تم فتح الكاميرا بنجاح');
                        })
                        .catch(error => {
                            addTestResult('فتح الكاميرا', 'error', `فشل في فتح الكاميرا: ${error.message}`);
                        });
                }
            } else {
                addTestResult('دالة الكاميرا', 'error', 'دالة openCameraOrFile غير متاحة');
            }
        }
        
        function testFileSelection() {
            addTestResult('اختبار اختيار الملف', 'info', 'بدء اختبار اختيار الملف...');
            
            if (typeof window.openCameraOrFile === 'function') {
                addTestResult('دالة اختيار الملف', 'success', 'دالة openCameraOrFile متاحة');
                
                // Test file selection
                openCameraOrFile('test_file', 'image/*')
                    .then(() => {
                        addTestResult('اختيار الملف', 'success', 'تم فتح نافذة اختيار الملف');
                    })
                    .catch(error => {
                        addTestResult('اختيار الملف', 'error', `فشل في اختيار الملف: ${error.message}`);
                    });
            } else {
                addTestResult('دالة اختيار الملف', 'error', 'دالة openCameraOrFile غير متاحة');
            }
        }
        
        function checkCameraSupport() {
            return !!(navigator.mediaDevices && 
                      navigator.mediaDevices.getUserMedia && 
                      window.isSecureContext);
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            addTestResult('تحميل الصفحة', 'success', 'تم تحميل الصفحة بنجاح');
            
            // Test if file upload manager is loaded
            if (typeof window.initFileUpload === 'function') {
                addTestResult('نظام رفع الملفات', 'success', 'تم تحميل نظام رفع الملفات');
                
                // Initialize file upload system
                if (window.initFileUpload()) {
                    addTestResult('تهيئة النظام', 'success', 'تم تهيئة نظام رفع الملفات بنجاح');
                    
                    // Generate test file upload fields
                    if (typeof window.generateFileUploadFields === 'function') {
                        window.generateFileUploadFields('restaurant');
                        addTestResult('إنشاء الحقول', 'success', 'تم إنشاء حقول رفع الملفات');
                    } else {
                        addTestResult('إنشاء الحقول', 'error', 'دالة generateFileUploadFields غير متاحة');
                    }
                } else {
                    addTestResult('تهيئة النظام', 'error', 'فشل في تهيئة نظام رفع الملفات');
                }
            } else {
                addTestResult('نظام رفع الملفات', 'error', 'نظام رفع الملفات غير متاح');
            }
            
            // Test Supabase connection
            if (typeof window.supabase !== 'undefined') {
                addTestResult('اتصال Supabase', 'success', 'تم الاتصال بـ Supabase');
            } else {
                addTestResult('اتصال Supabase', 'error', 'فشل في الاتصال بـ Supabase');
            }
        });
    </script>
</body>
</html>