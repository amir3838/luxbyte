<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل البيانات - LUXBYTE</title>
    <meta name="description" content="تسجيل البيانات والمستندات المطلوبة">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="/assets/app_icon/LUXBYTEICON.PNG" type="image/png">
</head>
<body class="unified-signup">
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <img src="/assets/app_icon/LUXBYTEICON.PNG" alt="LUXBYTE Logo">
                <span>LUXBYTE</span>
            </div>
            <nav class="nav">
                <a href="index.html">
                    <i class="fas fa-home"></i>
                    الرئيسية
                </a>
                <a href="choose-role.html">
                    <i class="fas fa-arrow-right"></i>
                    اختيار النشاط
                </a>
                <a href="dashboard.html">
                    <i class="fas fa-tachometer-alt"></i>
                    لوحة المراجعة
                </a>
                <a href="#" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    تسجيل الخروج
                </a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <!-- Page Header -->
        <div class="card text-center mb-8" id="page-header">
            <div class="card-header" style="justify-content: center;">
                <div class="card-icon">
                    <i class="fas fa-user-plus"></i>
                </div>
                <div>
                    <h1 class="card-title" style="font-size: 32px; margin-bottom: 8px;" data-i18n="reg.title">تسجيل البيانات</h1>
                    <p style="color: #666; font-size: 18px;" id="page-description" data-i18n="reg.helper">املأ البيانات المطلوبة</p>
                </div>
            </div>
        </div>

        <!-- Signup Form -->
        <div class="card">
            <form id="signupForm">
                <!-- Personal Information Section -->
                <div class="form-section">
                    <h3 style="margin-bottom: 24px; color: #333; border-bottom: 2px solid #e5e7eb; padding-bottom: 12px;">
                        <i class="fas fa-user" style="margin-left: 8px; color: #6b7cff;"></i>
                        البيانات الشخصية
                    </h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">الاسم الأول <span style="color: #ef4444;">*</span></label>
                            <input type="text" class="form-control" name="first_name" placeholder="أدخل اسمك الأول" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">اسم العائلة <span style="color: #ef4444;">*</span></label>
                            <input type="text" class="form-control" name="last_name" placeholder="أدخل اسم العائلة" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">البريد الإلكتروني <span style="color: #ef4444;">*</span></label>
                        <input type="email" class="form-control" name="email" placeholder="example@email.com" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">كلمة المرور <span style="color: #ef4444;">*</span></label>
                            <input type="password" class="form-control" name="password" placeholder="أدخل كلمة المرور" dir="ltr" autocomplete="new-password" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">تأكيد كلمة المرور <span style="color: #ef4444;">*</span></label>
                            <input type="password" class="form-control" name="confirm_password" placeholder="أكد كلمة المرور" dir="ltr" autocomplete="new-password" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">رقم الهاتف <span style="color: #ef4444;">*</span></label>
                        <input type="tel" class="form-control" name="phone" placeholder="01xxxxxxxxx" required>
                    </div>
                </div>

                <!-- Business Information Section -->
                <div class="form-section">
                    <h3 style="margin-bottom: 24px; color: #333; border-bottom: 2px solid #e5e7eb; padding-bottom: 12px;">
                        <i class="fas fa-building" style="margin-left: 8px; color: #6b7cff;"></i>
                        بيانات النشاط التجاري
                    </h3>

                    <div class="form-group">
                        <label class="form-label">اسم النشاط/المؤسسة <span style="color: #ef4444;">*</span></label>
                        <input type="text" class="form-control" name="business_name" placeholder="أدخل اسم النشاط التجاري" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">وصف النشاط</label>
                        <textarea class="form-control" name="description" placeholder="وصف مختصر للنشاط التجاري" rows="3"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">المحافظة <span style="color: #ef4444;">*</span></label>
                            <select class="form-control" name="governorate" id="governorate" required>
                                <option value="">اختر المحافظة</option>
                                <option value="القاهرة">القاهرة</option>
                                <option value="الجيزة">الجيزة</option>
                                <option value="الإسكندرية">الإسكندرية</option>
                                <option value="الشرقية">الشرقية</option>
                                <option value="الدقهلية">الدقهلية</option>
                                <option value="البحيرة">البحيرة</option>
                                <option value="المنيا">المنيا</option>
                                <option value="أسيوط">أسيوط</option>
                                <option value="سوهاج">سوهاج</option>
                                <option value="قنا">قنا</option>
                                <option value="الأقصر">الأقصر</option>
                                <option value="أسوان">أسوان</option>
                                <option value="البحر الأحمر">البحر الأحمر</option>
                                <option value="الوادي الجديد">الوادي الجديد</option>
                                <option value="مطروح">مطروح</option>
                                <option value="شمال سيناء">شمال سيناء</option>
                                <option value="جنوب سيناء">جنوب سيناء</option>
                                <option value="كفر الشيخ">كفر الشيخ</option>
                                <option value="الغربية">الغربية</option>
                                <option value="المنوفية">المنوفية</option>
                                <option value="الفيوم">الفيوم</option>
                                <option value="بني سويف">بني سويف</option>
                                <option value="المنيا">المنيا</option>
                                <option value="أسيوط">أسيوط</option>
                                <option value="سوهاج">سوهاج</option>
                                <option value="قنا">قنا</option>
                                <option value="الأقصر">الأقصر</option>
                                <option value="أسوان">أسوان</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">المدينة/الحي <span style="color: #ef4444;">*</span></label>
                            <input type="text" class="form-control" name="city" placeholder="أدخل المدينة أو الحي" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">العنوان التفصيلي <span style="color: #ef4444;">*</span></label>
                        <textarea class="form-control" name="address" id="address" placeholder="أدخل العنوان التفصيلي" rows="2" required></textarea>
                    </div>

                    <!-- GPS Location -->
                    <div class="form-group">
                        <label class="form-label">الموقع الجغرافي</label>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <button type="button" id="getLocationBtn" class="btn btn-outline" style="white-space: nowrap;">
                                <i class="fas fa-map-marker-alt"></i>
                                الحصول على الموقع
                            </button>
                            <span id="locationStatus" style="color: #666; font-size: 14px;"></span>
                        </div>
                    </div>
                </div>

                <!-- File Upload Section -->
                <div class="form-section">
                    <h3 style="margin-bottom: 24px; color: #333; border-bottom: 2px solid #e5e7eb; padding-bottom: 12px;">
                        <i class="fas fa-camera" style="margin-left: 8px; color: #6b7cff;"></i>
                        تصوير المستندات المطلوبة
                    </h3>

                    <div id="file-upload-container">
                        <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                            <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 12px;"></i>
                            <p>جاري تحميل أزرار تصوير المستندات...</p>
                            <button type="button" onclick="testFileUploadGeneration()" class="btn btn-outline" style="margin-top: 16px;">
                                <i class="fas fa-refresh"></i>
                                إعادة تحميل أزرار التصوير
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Terms and Conditions -->
                <div class="form-section">
                    <h3 style="margin-bottom: 24px; color: #333; border-bottom: 2px solid #e5e7eb; padding-bottom: 12px;">
                        <i class="fas fa-file-contract" style="margin-left: 8px; color: #6b7cff;"></i>
                        الشروط والأحكام
                    </h3>

                    <div class="form-group">
                        <label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer;">
                            <input type="checkbox" name="terms_accepted" required style="margin-top: 4px;">
                            <span style="line-height: 1.5;">
                                أوافق على <a href="terms-conditions.html" target="_blank" style="color: #6b7cff; text-decoration: underline;">الشروط والأحكام</a>
                                و <a href="privacy-policy.html" target="_blank" style="color: #6b7cff; text-decoration: underline;">سياسة الخصوصية</a>
                                <span style="color: #ef4444;">*</span>
                            </span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer;">
                            <input type="checkbox" name="marketing_consent" style="margin-top: 4px;">
                            <span style="line-height: 1.5; color: #666;">
                                أريد تلقي العروض الترويجية والتحديثات عبر البريد الإلكتروني
                            </span>
                        </label>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="form-section" style="text-align: center; margin-top: 32px;">
                    <button type="submit" class="btn" style="font-size: 18px; padding: 16px 32px; min-width: 200px;">
                        <i class="fas fa-paper-plane"></i>
                        إرسال الطلب
                    </button>
                </div>
            </form>
        </div>
    </main>

    <!-- Footer -->
    <footer style="background: #1a1a1a; color: #666; padding: 32px 0; margin-top: 64px; text-align: center;">
        <div style="max-width: 1100px; margin: 0 auto; padding: 0 16px;">
            <p data-i18n="home.footer.copyright">&copy; 2024 LUXBYTE LLC. جميع الحقوق محفوظة.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    <script src="config.js" defer></script>
    <script src="js/supabase-client.js" defer></script>
    <script src="i18n-dict.js" defer></script>
    <script src="js/translation-utils.js" defer></script>
    <script src="common.js" defer></script>
    <script src="js/engagement-notification.js" defer></script>
    <script>
        // Global variables
        let selectedRole = null;
        let uploadedFiles = {};

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('🚀 LUXBYTE Unified Signup Page Loaded');

                // Get role from URL parameter
                const urlParams = new URLSearchParams(window.location.search);
                selectedRole = urlParams.get('role');
                console.log('🎯 Selected role from URL:', selectedRole);
                console.log('📋 Available roles:', Object.keys(window.CONFIG.ROLES));

                // If no role from URL, try to get from localStorage or default
                if (!selectedRole) {
                    selectedRole = localStorage.getItem('selectedRole') || 'restaurant';
                    console.log('🔄 Using fallback role:', selectedRole);
                }

                if (!selectedRole || !window.CONFIG.ROLES[selectedRole]) {
                    LUXBYTE.notifyErr('نوع النشاط غير صحيح');
                    window.location.href = 'choose-role.html';
                    return;
                }

                // Update page header with role info
                const roleConfig = window.CONFIG.ROLES[selectedRole];
                const pageDescription = document.getElementById('page-description');
                if (pageDescription) {
                    pageDescription.textContent = `تسجيل بيانات ${roleConfig.name}`;
                }

                // Setup form
                setupForm();

                // Setup GPS location
                setupGPSLocation();

                // Initialize common elements
                applyI18n();

                // Generate file upload fields after role is determined
                console.log('🚀 Generating file upload fields after role determination...');
                console.log('🔍 Debug info:', {
                    selectedRole,
                    hasConfig: !!window.CONFIG,
                    hasRoles: !!(window.CONFIG && window.CONFIG.ROLES),
                    roleConfig: window.CONFIG && window.CONFIG.ROLES ? window.CONFIG.ROLES[selectedRole] : null
                });
                
                if (selectedRole && window.CONFIG && window.CONFIG.ROLES && window.CONFIG.ROLES[selectedRole]) {
                    generateFileUploadFields();
                } else {
                    console.error('❌ Cannot generate file upload fields - missing role or config');
                    LUXBYTE.notifyErr('خطأ في تحديد نوع النشاط - يرجى إعادة تحميل الصفحة');
                    
                    // Try again after a short delay
                    setTimeout(() => {
                        if (selectedRole && window.CONFIG && window.CONFIG.ROLES && window.CONFIG.ROLES[selectedRole]) {
                            console.log('🔄 Retrying file upload generation...');
                            generateFileUploadFields();
                        }
                    }, 1000);
                }

            } catch (error) {
                console.error('❌ Error during page initialization:', error);
                LUXBYTE.notifyErr('حدث خطأ في تحميل الصفحة. يرجى إعادة تحميل الصفحة.');
            }
        });

        // Setup form
        function setupForm() {
            const form = document.getElementById('signupForm');
            if (!form) return;

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('📝 Form submitted');

                try {
                    // Show loading
                    const submitBtn = form.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإرسال...';
                    submitBtn.disabled = true;

                    // Get form data
                    const formData = new FormData(form);
                    const email = formData.get('email');
                    const password = (formData.get('password') ?? '').toString();
                    const confirmPassword = (formData.get('confirm_password') ?? '').toString();

                    // Password validation
                    const stripBidi = (s) => s.replace(/[\u200E\u200F\u061C]/g, '').normalize('NFC');
                    const passwordClean = stripBidi(password);
                    const confirmClean = stripBidi(confirmPassword);

                    if (!passwordClean || !confirmClean) {
                        throw new Error('أدخل كلمة المرور والتأكيد');
                    }

                    if (passwordClean !== confirmClean) {
                        throw new Error('كلمات المرور غير متطابقة');
                    }

                    // Create user account
                    const { data: authData, error: authError } = await LUXBYTE.supabase.auth.signUp({
                        email: email,
                        password: passwordClean
                    });

                    if (authError) throw authError;

                    if (!authData.user) {
                        throw new Error('فشل في إنشاء الحساب');
                    }

                    // Prepare business data
                    const businessData = {
                        user_id: authData.user.id,
                        first_name: formData.get('first_name'),
                        last_name: formData.get('last_name'),
                        email: email,
                        phone: formData.get('phone'),
                        business_name: formData.get('business_name'),
                        description: formData.get('description'),
                        governorate: formData.get('governorate'),
                        city: formData.get('city'),
                        address: formData.get('address'),
                        role: selectedRole,
                        terms_accepted: formData.get('terms_accepted') === 'on',
                        marketing_consent: formData.get('marketing_consent') === 'on',
                        status: 'pending',
                        created_at: new Date().toISOString()
                    };

                    // Insert business data
                    const { data: insertData, error: insertError } = await LUXBYTE.supabase
                        .from(roleConfig.table)
                        .insert([businessData]);

                    if (insertError) throw insertError;

                    // Upload files if any
                    if (Object.keys(uploadedFiles).length > 0) {
                        console.log('📁 Uploading photos...');
                        await uploadFiles(authData.user.id, insertData[0].id);
                    }

                    LUXBYTE.notifyOk('تم إرسال الطلب بنجاح! سيتم مراجعته قريباً.');

                    // Redirect to success page
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 2000);

                } catch (error) {
                    console.error('❌ Signup error:', error);
                    LUXBYTE.notifyErr(error.message || 'حدث خطأ في إرسال الطلب');
                } finally {
                    // Reset button
                    const submitBtn = form.querySelector('button[type="submit"]');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            });
        }

        // Setup GPS location
        function setupGPSLocation() {
            console.log('🗺️ Setting up GPS location...');
            const getLocationBtn = document.getElementById('getLocationBtn');
            const addressField = document.getElementById('address');
            const locationStatus = document.getElementById('locationStatus');

            if (!getLocationBtn) {
                console.error('❌ GPS button not found!');
                return;
            }

            getLocationBtn.addEventListener('click', async () => {
                console.log('GPS button clicked!');
                if (!navigator.geolocation) {
                    locationStatus.innerHTML = '<span style="color: #ef4444;"><i class="fas fa-exclamation-triangle"></i> المتصفح لا يدعم GPS</span>';
                    LUXBYTE.notifyErr('المتصفح لا يدعم GPS');
                    return;
                }

                locationStatus.innerHTML = '<span style="color: #6b7280;"><i class="fas fa-spinner fa-spin"></i> جاري الحصول على الموقع...</span>';
                getLocationBtn.disabled = true;
                getLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري...';

                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 15000,
                            maximumAge: 300000
                        });
                    });

                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    console.log('Location obtained:', { lat, lng });

                    await getAddressFromCoordinates(lat, lng);
                    locationStatus.innerHTML = `<span style="color: #10b981;"><i class="fas fa-check"></i> تم الحصول على الموقع: ${lat.toFixed(6)}, ${lng.toFixed(6)}</span>`;
                    LUXBYTE.notifyOk('تم الحصول على الموقع بنجاح');

                } catch (error) {
                    console.error('GPS Error:', error);
                    let errorMessage = 'حدث خطأ في الحصول على الموقع';
                    let errorIcon = 'fas fa-exclamation-triangle';

                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'تم رفض إذن الوصول للموقع. يرجى السماح بالوصول للموقع في إعدادات المتصفح';
                            errorIcon = 'fas fa-ban';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'الموقع غير متاح حالياً. تأكد من تشغيل GPS';
                            errorIcon = 'fas fa-map-marker-slash';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'انتهت مهلة الطلب. حاول مرة أخرى';
                            errorIcon = 'fas fa-clock';
                            break;
                    }

                    locationStatus.innerHTML = `<span style="color: #ef4444;"><i class="${errorIcon}"></i> ${errorMessage}</span>`;
                    LUXBYTE.notifyErr(errorMessage);
                } finally {
                    getLocationBtn.disabled = false;
                    getLocationBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i> الحصول على الموقع';
                }
            });
        }

        // Get address from coordinates
        async function getAddressFromCoordinates(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ar`);
                const data = await response.json();

                if (data && data.display_name) {
                    const addressField = document.getElementById('address');
                    if (addressField) {
                        addressField.value = data.display_name;
                        console.log('Address set:', data.display_name);
                    }
                }
            } catch (error) {
                console.error('Error getting address:', error);
            }
        }

        // Generate file upload fields
        function generateFileUploadFields() {
            console.log('🔧 Starting generateFileUploadFields...');
            console.log('🎯 Current selectedRole:', selectedRole);
            console.log('📋 Available roles:', Object.keys(window.CONFIG.ROLES));

            const roleConfig = window.CONFIG.ROLES[selectedRole];
            const container = document.getElementById('file-upload-container');

            console.log('📊 Role config:', roleConfig);
            console.log('📦 Container found:', !!container);

            if (!container) {
                console.error('❌ File upload container not found!');
                LUXBYTE.notifyErr('لم يتم العثور على حاوية تصوير المستندات');
                return;
            }

            container.innerHTML = ''; // Clear container

            if (!roleConfig) {
                console.error('❌ No role config found for:', selectedRole);
                container.innerHTML = `<div style="text-align: center; padding: 40px; color: #ef4444;"><i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 12px;"></i><p style="font-size: 16px; margin: 0;">خطأ: لم يتم العثور على إعدادات النشاط</p></div>`;
                return;
            }

            if (!roleConfig.files || roleConfig.files.length === 0) {
                console.warn('⚠️ No files required for role:', selectedRole);
                container.innerHTML = `<div style="text-align: center; padding: 40px; color: #f59e0b;"><i class="fas fa-info-circle" style="font-size: 24px; margin-bottom: 12px;"></i><p style="font-size: 16px; margin: 0;">لا توجد مستندات مطلوبة لهذا النشاط</p></div>`;
                return;
            }

            console.log('✅ Found', roleConfig.files.length, 'files to generate');

            // Create header with instructions
            const headerDiv = document.createElement('div');
            headerDiv.style.cssText = `background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border: 1px solid #0ea5e9; border-radius: 12px; padding: 20px; margin-bottom: 24px; text-align: center;`;
            headerDiv.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 12px;">
                    <i class="fas fa-info-circle" style="color: #0ea5e9; font-size: 24px;"></i>
                    <h4 style="margin: 0; color: #0c4a6e; font-size: 18px;">تعليمات تصوير المستندات</h4>
                </div>
                <p style="margin: 0; color: #075985; font-size: 14px; line-height: 1.5;">
                    • اضغط على أي منطقة لتصوير المستند بالكاميرا<br>
                    • المستندات المطلوبة marked بـ (*)<br>
                    • الحد الأقصى لحجم الصورة: 10 ميجابايت<br>
                    • استخدم الكاميرا لتصوير المستندات بوضوح
                </p>
            `;
            container.appendChild(headerDiv);

            // Generate file upload fields
            roleConfig.files.forEach((file, index) => {
                console.log(`📁 Creating field ${index + 1}/${roleConfig.files.length}:`, file.name);

                const fileDiv = document.createElement('div');
                fileDiv.className = 'form-group';
                fileDiv.style.cssText = 'margin-bottom: 24px;';

                const label = document.createElement('label');
                label.className = 'form-label';
                label.style.cssText = 'font-weight: 600; margin-bottom: 8px; display: block;';
                label.innerHTML = `${file.label} ${file.required ? '<span style="color: #ef4444;">*</span>' : ''}`;
                fileDiv.appendChild(label);

                const uploadDiv = document.createElement('div');
                uploadDiv.className = 'file-upload';
                uploadDiv.setAttribute('data-file-name', file.name);
                uploadDiv.style.cssText = `border: 2px dashed #d1d5db; border-radius: 12px; padding: 24px; text-align: center; cursor: pointer; transition: all 0.3s ease; background: #fafbfc; position: relative; overflow: hidden; min-height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px;`;

                uploadDiv.innerHTML = `
                    <div class="upload-icon" style="font-size: 32px; color: #6b7280;">
                        <i class="fas fa-camera"></i>
                    </div>
                    <div class="upload-text" style="font-size: 16px; font-weight: 500; color: #374151;">
                        اضغط لتصوير ${file.label}
                    </div>
                    <div class="upload-requirement" style="font-size: 14px; color: #6b7280; margin-top: 4px;">
                        ${file.description} - استخدم الكاميرا لتصوير المستند
                    </div>
                    <div class="upload-button" style="background: #3b82f6; color: white; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; margin-top: 8px;">
                        <i class="fas fa-camera"></i>
                        تصوير بالكاميرا
                    </div>
                    <input type="file" class="file-input" accept="image/*" capture="environment" ${file.required ? 'required' : ''} style="display: none;">
                `;

                // Event listeners
                uploadDiv.addEventListener('mouseenter', () => {
                    uploadDiv.style.borderColor = '#3b82f6';
                    uploadDiv.style.background = '#f0f9ff';
                    uploadDiv.style.transform = 'translateY(-2px)';
                    uploadDiv.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.15)';
                });

                uploadDiv.addEventListener('mouseleave', () => {
                    if (!uploadDiv.classList.contains('uploaded')) {
                        uploadDiv.style.borderColor = '#d1d5db';
                        uploadDiv.style.background = '#fafbfc';
                        uploadDiv.style.transform = 'translateY(0)';
                        uploadDiv.style.boxShadow = 'none';
                    }
                });

                uploadDiv.addEventListener('click', (e) => {
                    e.preventDefault();
                    uploadDiv.querySelector('.file-input').click();
                });

                // Drag and drop
                uploadDiv.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadDiv.classList.add('dragover');
                    uploadDiv.style.borderColor = '#10b981';
                    uploadDiv.style.background = '#f0fdf4';
                });

                uploadDiv.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    uploadDiv.classList.remove('dragover');
                    if (!uploadDiv.classList.contains('uploaded')) {
                        uploadDiv.style.borderColor = '#d1d5db';
                        uploadDiv.style.background = '#fafbfc';
                    }
                });

                uploadDiv.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadDiv.classList.remove('dragover');
                    uploadDiv.style.borderColor = '#d1d5db';
                    uploadDiv.style.background = '#fafbfc';
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const fileInput = uploadDiv.querySelector('.file-input');
                        fileInput.files = files;
                        handleFileUpload({ target: fileInput }, file, uploadDiv);
                    }
                });

                uploadDiv.querySelector('.file-input').addEventListener('change', (e) => {
                    handleFileUpload(e, file, uploadDiv);
                });

                fileDiv.appendChild(uploadDiv);
                container.appendChild(fileDiv);
            });

            console.log(`✅ Generated ${roleConfig.files.length} file upload fields successfully`);
            if (roleConfig.files.length > 0) {
                LUXBYTE.notifyOk(`تم تحميل ${roleConfig.files.length} أزرار تصوير المستندات بنجاح`);
            }
        }

        // Handle file upload
        function handleFileUpload(event, fileConfig, container) {
            const file = event.target.files[0];
            if (!file) {
                console.log('No photo selected');
                return;
            }

            console.log('Photo selected:', { name: file.name, size: file.size, type: file.type });

            if (!validateFile(file, fileConfig)) {
                return;
            }

            container.classList.add('uploaded');
            container.style.borderColor = '#10b981';
            container.style.background = '#f0fdf4';

            const uploadText = container.querySelector('.upload-text');
            const uploadButton = container.querySelector('.upload-button');

            if (uploadText) {
                uploadText.innerHTML = `<i class="fas fa-check-circle" style="color: #10b981; margin-left: 8px;"></i>تم رفع: ${file.name}`;
            }

            if (uploadButton) {
                uploadButton.innerHTML = `<i class="fas fa-check"></i>تم الرفع`;
                uploadButton.style.background = '#10b981';
            }

            // Add file info
            const fileInfo = document.createElement('div');
            fileInfo.className = 'file-info';
            fileInfo.style.cssText = `margin-top: 12px; padding: 12px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; font-size: 14px; color: #065f46;`;
            fileInfo.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span><strong>الملف:</strong> ${file.name}</span>
                    <span><strong>الحجم:</strong> ${LUXBYTE.formatFileSize(file.size)}</span>
                </div>
                <div style="margin-top: 8px;">
                    <button type="button" onclick="removeFile('${fileConfig.name}', this)" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">
                        <i class="fas fa-trash"></i> إزالة
                    </button>
                </div>
            `;

            const existingInfo = container.querySelector('.file-info');
            if (existingInfo) {
                existingInfo.remove();
            }
            container.appendChild(fileInfo);

            uploadedFiles[fileConfig.name] = file;
            console.log('Photo uploaded successfully:', fileConfig.name);
            LUXBYTE.notifyOk(`تم تصوير ${fileConfig.label} بنجاح`);
        }

        // Validate file
        function validateFile(file, fileConfig) {
            console.log('Validating file:', { name: file.name, type: file.type, size: file.size });

            // Only accept images (camera photos)
            if (!file.type.startsWith('image/')) {
                console.log('Invalid image type:', file.type);
                LUXBYTE.notifyErr('يرجى تصوير المستند بالكاميرا - الصور فقط مسموحة');
                return false;
            }

            const maxSize = 10 * 1024 * 1024; // 10MB for camera photos
            if (file.size > maxSize) {
                console.log('File too large:', file.size, 'Max:', maxSize);
                LUXBYTE.notifyErr('حجم الصورة كبير جداً - الحد الأقصى 10 ميجابايت');
                return false;
            }

            console.log('File validation passed');
            return true;
        }

        // Remove file
        function removeFile(fileName, buttonElement) {
            console.log('Removing photo:', fileName);
            delete uploadedFiles[fileName];

            const container = buttonElement.closest('.file-upload');
            if (container) {
                container.classList.remove('uploaded');
                container.style.borderColor = '#d1d5db';
                container.style.background = '#fafbfc';

                const uploadText = container.querySelector('.upload-text');
                const uploadButton = container.querySelector('.upload-button');

                if (uploadText) {
                    uploadText.innerHTML = `اضغط لتصوير ${fileName}`;
                }

                if (uploadButton) {
                    uploadButton.innerHTML = `<i class="fas fa-camera"></i>تصوير بالكاميرا`;
                    uploadButton.style.background = '#3b82f6';
                }

                const fileInfo = container.querySelector('.file-info');
                if (fileInfo) {
                    fileInfo.remove();
                }

                const fileInput = container.querySelector('.file-input');
                if (fileInput) {
                    fileInput.value = '';
                }
            }

            LUXBYTE.notifyOk('تم حذف الصورة');
        }

        // Upload photos to Supabase Storage
        async function uploadFiles(userId, businessId) {
            const roleConfig = window.CONFIG.ROLES[selectedRole];
            const bucket = roleConfig.bucket;

            for (const [fileName, file] of Object.entries(uploadedFiles)) {
                try {
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${userId}/${businessId}/${fileName}.${fileExt}`;

                    const { data, error } = await LUXBYTE.supabase.storage
                        .from(bucket)
                        .upload(fileName, file);

                    if (error) throw error;
                    console.log('Photo uploaded to storage:', fileName);
                } catch (error) {
                    console.error('Error uploading photo:', fileName, error);
                    LUXBYTE.notifyErr(`فشل في رفع الصورة: ${fileName}`);
                }
            }
        }

        // Test function for file upload generation
        function testFileUploadGeneration() {
            console.log('🧪 Testing file upload generation...');
            console.log('🔍 Current state:', {
                selectedRole,
                hasConfig: !!window.CONFIG,
                hasRoles: !!(window.CONFIG && window.CONFIG.ROLES),
                roleConfig: window.CONFIG && window.CONFIG.ROLES ? window.CONFIG.ROLES[selectedRole] : null
            });
            
            if (selectedRole && window.CONFIG && window.CONFIG.ROLES && window.CONFIG.ROLES[selectedRole]) {
                generateFileUploadFields();
                LUXBYTE.notifyOk('تم إعادة تحميل أزرار التصوير');
            } else {
                LUXBYTE.notifyErr('لا يمكن تحميل أزرار التصوير - تحقق من نوع النشاط');
            }
        }

        // Logout function
        async function logout() {
            try {
                await LUXBYTE.supabase.auth.signOut();
                LUXBYTE.notifyOk('تم تسجيل الخروج بنجاح');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            } catch (error) {
                console.error('Logout error:', error);
                LUXBYTE.notifyErr('حدث خطأ في تسجيل الخروج');
            }
        }
    </script>
</body>
</html>
