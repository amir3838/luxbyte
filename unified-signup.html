<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - LUXBYTE</title>
    <meta name="description" content="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©">

    <!-- Permissions for Camera and Location -->
    <meta name="theme-color" content="#6b7cff">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="/assets/app_icon/LUXBYTEICON.PNG" type="image/png">
    <link rel="apple-touch-icon" href="/assets/app_icon/LUXBYTEICON.PNG">
</head>
<body class="unified-signup">
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <img src="/assets/app_icon/LUXBYTEICON.PNG" alt="LUXBYTE Logo">
                <span>LUXBYTE</span>
            </div>
            <nav class="nav">
                <a href="index.html">
                    <i class="fas fa-home"></i>
                    Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                </a>
                <a href="choose-role.html">
                    <i class="fas fa-arrow-right"></i>
                    Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ø´Ø§Ø·
                </a>
                <a href="dashboard.html">
                    <i class="fas fa-tachometer-alt"></i>
                    Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
                </a>
                <a href="#" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                </a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <!-- Page Header -->
        <div class="card text-center mb-8" id="page-header">
            <div class="card-header" style="justify-content: center;">
                <div class="card-icon">
                    <i class="fas fa-user-plus"></i>
                </div>
                <div>
                    <h1 class="card-title" style="font-size: 32px; margin-bottom: 8px;" data-i18n="reg.title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h1>
                    <p style="color: #666; font-size: 18px;" id="page-description" data-i18n="reg.helper">Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</p>
                </div>
            </div>
        </div>

        <!-- Signup Form -->
        <div class="card">
            <form id="signupForm">
                <!-- Personal Information Section -->
                <div class="form-section">
                    <h3 style="margin-bottom: 24px; color: #333; border-bottom: 2px solid #e5e7eb; padding-bottom: 12px;">
                        <i class="fas fa-user" style="margin-left: 8px; color: #6b7cff;"></i>
                        Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©
                    </h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„ <span style="color: #ef4444;">*</span></label>
                            <input type="text" class="form-control" name="first_name" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø£ÙˆÙ„" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© <span style="color: #ef4444;">*</span></label>
                            <input type="text" class="form-control" name="last_name" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ <span style="color: #ef4444;">*</span></label>
                        <input type="email" class="form-control" name="email" placeholder="example@email.com" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± <span style="color: #ef4444;">*</span></label>
                            <input type="password" class="form-control" name="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" dir="ltr" autocomplete="new-password" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± <span style="color: #ef4444;">*</span></label>
                            <input type="password" class="form-control" name="confirm_password" placeholder="Ø£ÙƒØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" dir="ltr" autocomplete="new-password" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ <span style="color: #ef4444;">*</span></label>
                        <input type="tel" class="form-control" name="phone" placeholder="01xxxxxxxxx" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨ <span style="color: #ef4444;">*</span></label>
                        <select class="form-control" name="account_type" id="accountType" required title="Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨">
                            <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨</option>
                            <option value="pharmacy">ØµÙŠØ¯Ù„ÙŠØ©</option>
                            <option value="supermarket">Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª</option>
                            <option value="restaurant">Ù…Ø·Ø¹Ù…</option>
                            <option value="clinic">Ø¹ÙŠØ§Ø¯Ø©</option>
                            <option value="courier">Ù…Ù†Ø¯ÙˆØ¨ ØªÙˆØµÙŠÙ„</option>
                            <option value="driver">Ø³Ø§Ø¦Ù‚</option>
                        </select>
                    </div>
                </div>

                <!-- Business Information Section -->
                <div class="form-section">
                    <h3 style="margin-bottom: 24px; color: #333; border-bottom: 2px solid #e5e7eb; padding-bottom: 12px;">
                        <i class="fas fa-building" style="margin-left: 8px; color: #6b7cff;"></i>
                        Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØªØ¬Ø§Ø±ÙŠ
                    </h3>

                    <div class="form-group">
                        <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø·/Ø§Ù„Ù…Ø¤Ø³Ø³Ø© <span style="color: #ef4444;">*</span></label>
                        <input type="text" class="form-control" name="business_name" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØªØ¬Ø§Ø±ÙŠ" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ÙˆØµÙ Ø§Ù„Ù†Ø´Ø§Ø·</label>
                        <textarea class="form-control" name="description" placeholder="ÙˆØµÙ Ù…Ø®ØªØµØ± Ù„Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØªØ¬Ø§Ø±ÙŠ" rows="3"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© <span style="color: #ef4444;">*</span></label>
                            <select class="form-control" name="governorate" id="governorate" required title="Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option>
                                <option value="Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©">Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©</option>
                                <option value="Ø§Ù„Ø¬ÙŠØ²Ø©">Ø§Ù„Ø¬ÙŠØ²Ø©</option>
                                <option value="Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©">Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©</option>
                                <option value="Ø§Ù„Ø´Ø±Ù‚ÙŠØ©">Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</option>
                                <option value="Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©">Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©</option>
                                <option value="Ø§Ù„Ø¨Ø­ÙŠØ±Ø©">Ø§Ù„Ø¨Ø­ÙŠØ±Ø©</option>
                                <option value="Ø§Ù„Ù…Ù†ÙŠØ§">Ø§Ù„Ù…Ù†ÙŠØ§</option>
                                <option value="Ø£Ø³ÙŠÙˆØ·">Ø£Ø³ÙŠÙˆØ·</option>
                                <option value="Ø³ÙˆÙ‡Ø§Ø¬">Ø³ÙˆÙ‡Ø§Ø¬</option>
                                <option value="Ù‚Ù†Ø§">Ù‚Ù†Ø§</option>
                                <option value="Ø§Ù„Ø£Ù‚ØµØ±">Ø§Ù„Ø£Ù‚ØµØ±</option>
                                <option value="Ø£Ø³ÙˆØ§Ù†">Ø£Ø³ÙˆØ§Ù†</option>
                                <option value="Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±">Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±</option>
                                <option value="Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯">Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯</option>
                                <option value="Ù…Ø·Ø±ÙˆØ­">Ù…Ø·Ø±ÙˆØ­</option>
                                <option value="Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡">Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡</option>
                                <option value="Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡">Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡</option>
                                <option value="ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®">ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®</option>
                                <option value="Ø§Ù„ØºØ±Ø¨ÙŠØ©">Ø§Ù„ØºØ±Ø¨ÙŠØ©</option>
                                <option value="Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©">Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©</option>
                                <option value="Ø§Ù„ÙÙŠÙˆÙ…">Ø§Ù„ÙÙŠÙˆÙ…</option>
                                <option value="Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ">Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ</option>
                                <option value="Ø§Ù„Ù…Ù†ÙŠØ§">Ø§Ù„Ù…Ù†ÙŠØ§</option>
                                <option value="Ø£Ø³ÙŠÙˆØ·">Ø£Ø³ÙŠÙˆØ·</option>
                                <option value="Ø³ÙˆÙ‡Ø§Ø¬">Ø³ÙˆÙ‡Ø§Ø¬</option>
                                <option value="Ù‚Ù†Ø§">Ù‚Ù†Ø§</option>
                                <option value="Ø§Ù„Ø£Ù‚ØµØ±">Ø§Ù„Ø£Ù‚ØµØ±</option>
                                <option value="Ø£Ø³ÙˆØ§Ù†">Ø£Ø³ÙˆØ§Ù†</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©/Ø§Ù„Ø­ÙŠ <span style="color: #ef4444;">*</span></label>
                            <input type="text" class="form-control" name="city" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø£Ùˆ Ø§Ù„Ø­ÙŠ" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ <span style="color: #ef4444;">*</span></label>
                        <textarea class="form-control" name="address" id="address" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ" rows="2" required></textarea>
                    </div>

                    <!-- GPS Location -->
                    <div class="form-group">
                        <label class="form-label">Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ</label>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <button type="button" id="getLocationBtn" class="btn btn-outline" style="white-space: nowrap;">
                                <i class="fas fa-map-marker-alt"></i>
                                Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹
                            </button>
                            <span id="locationStatus" style="color: #666; font-size: 14px;"></span>
                        </div>
                    </div>
                </div>

                <!-- File Upload Section -->
                <div class="form-section">
                    <!-- Error Banner -->
                    <div id="pageErrorBanner" style="display: none;"></div>

                    <!-- Loading Spinner -->
                    <div id="uploadButtonsSpinner" style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 12px;"></i>
                        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±...</p>
                    </div>

                    <!-- Upload Buttons Container -->
                    <div id="uploadButtonsContainer">
                        <!-- Sample upload fields for testing -->
                        <div class="file-upload-field" style="margin-bottom: 20px; padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb;">
                            <div class="file-upload-label">
                                <label style="font-weight: 600; color: #374151; margin-bottom: 5px; display: block;">
                                    Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ
                                </label>
                                <p class="file-description" style="font-size: 12px; color: #6b7280; margin: 5px 0 0 0;">
                                    PDF Ø£Ùˆ JPG ÙˆØ§Ø¶Ø­Ø©
                                </p>
                            </div>
                            <div class="file-upload-controls" style="margin-top: 10px;">
                                <input type="file" id="commercial_register" data-upload-input accept=".pdf,.jpg,.jpeg" style="display: none;">
                                <input type="hidden" id="commercial_register_url">
                                <button type="button" data-upload-btn data-for="#commercial_register" data-bind="#commercial_register_url" class="upload-btn" style="background: #6b7cff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; display: inline-flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-upload"></i> Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Terms and Conditions -->
                <div class="form-section">
                    <h3 style="margin-bottom: 24px; color: #333; border-bottom: 2px solid #e5e7eb; padding-bottom: 12px;">
                        <i class="fas fa-file-contract" style="margin-left: 8px; color: #6b7cff;"></i>
                        Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…
                    </h3>

                    <div class="form-group">
                        <label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer;">
                            <input type="checkbox" name="terms_accepted" required style="margin-top: 4px;">
                            <span style="line-height: 1.5;">
                                Ø£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ <a href="terms-conditions.html" target="_blank" style="color: #6b7cff; text-decoration: underline;">Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…</a>
                                Ùˆ <a href="privacy-policy.html" target="_blank" style="color: #6b7cff; text-decoration: underline;">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</a>
                                <span style="color: #ef4444;">*</span>
                            </span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer;">
                            <input type="checkbox" name="marketing_consent" style="margin-top: 4px;">
                            <span style="line-height: 1.5; color: #666;">
                                Ø£Ø±ÙŠØ¯ ØªÙ„Ù‚ÙŠ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ØªØ±ÙˆÙŠØ¬ÙŠØ© ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
                            </span>
                        </label>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="form-section" style="text-align: center; margin-top: 32px;">
                    <button type="submit" class="btn" style="font-size: 18px; padding: 16px 32px; min-width: 200px;">
                        <i class="fas fa-paper-plane"></i>
                        Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
                    </button>
                </div>
            </form>
        </div>
    </main>

    <!-- Footer -->
    <footer style="background: #1a1a1a; color: #666; padding: 32px 0; margin-top: 64px; text-align: center;">
        <div style="max-width: 1100px; margin: 0 auto; padding: 0 16px;">
            <p data-i18n="home.footer.copyright">&copy; 2024 LUXBYTE LLC. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <!-- Core Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    <script src="config.js" defer></script>
    <script src="js/supabase-client.js" defer></script>

    <!-- Utility Scripts -->
    <script src="i18n-dict.js" defer></script>
    <script src="js/translation-utils.js" defer></script>
    <script src="common.js" defer></script>
    <script src="js/engagement-notification.js" defer></script>
    <script src="js/enhanced-ui.js" defer></script>
    <script src="js/comprehensive-test.js" defer></script>

    <!-- New Environment System -->
    <script type="module" src="src/utils/env.js"></script>
    <script type="module" src="src/utils/toast.js"></script>
    <script type="module" src="src/integrations/supabase.js"></script>
    <script type="module" src="src/ui/upload.js"></script>

    <!-- Legacy File Upload Manager (for backward compatibility) -->
    <script src="js/file-upload-manager.js" defer></script>
    <script>
        // Global variables
        let selectedRole = null;
        let uploadedFiles = {};

        // Request permissions
        async function requestPermissions() {
            const permissions = {
                camera: false,
                location: false,
                notifications: false
            };

            try {
                console.log('ğŸ” Requesting permissions...');

                // Request camera permission
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    try {
                        console.log('ğŸ“¸ Requesting camera permission...');
                        const stream = await navigator.mediaDevices.getUserMedia({
                            video: {
                                facingMode: 'environment',
                                width: { ideal: 1280 },
                                height: { ideal: 720 }
                            }
                        });
                        stream.getTracks().forEach(track => track.stop());
                        permissions.camera = true;
                        console.log('âœ… Camera permission granted');
                        LUXBYTE.notifyOk('ØªÙ… Ù…Ù†Ø­ Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¨Ù†Ø¬Ø§Ø­');
                    } catch (cameraError) {
                        console.warn('âš ï¸ Camera permission denied:', cameraError.message);
                        LUXBYTE.notifyWarn('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„ØªØµÙˆÙŠØ± Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª');
                    }
                } else {
                    console.warn('âš ï¸ Camera not supported on this device');
                    LUXBYTE.notifyWarn('Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²');
                }

                // Request location permission
                if (navigator.geolocation) {
                    try {
                        console.log('ğŸ“ Requesting location permission...');
                        await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, {
                                enableHighAccuracy: true,
                                timeout: 10000,
                                maximumAge: 300000
                            });
                        });
                        permissions.location = true;
                        console.log('âœ… Location permission granted');
                        LUXBYTE.notifyOk('ØªÙ… Ù…Ù†Ø­ Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ø¨Ù†Ø¬Ø§Ø­');
                    } catch (locationError) {
                        console.warn('âš ï¸ Location permission denied:', locationError.message);
                        LUXBYTE.notifyWarn('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ');
                    }
                } else {
                    console.warn('âš ï¸ Geolocation not supported');
                    LUXBYTE.notifyWarn('Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²');
                }

                // Request notification permission
                if ('Notification' in window) {
                    try {
                        console.log('ğŸ”” Requesting notification permission...');
                        if (Notification.permission === 'default') {
                            const notificationPermission = await Notification.requestPermission();
                            permissions.notifications = notificationPermission === 'granted';
                            console.log('âœ… Notification permission:', notificationPermission);
                            if (notificationPermission === 'granted') {
                                LUXBYTE.notifyOk('ØªÙ… Ù…Ù†Ø­ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                            }
                        } else {
                            permissions.notifications = Notification.permission === 'granted';
                            console.log('âœ… Notification permission already set:', Notification.permission);
                        }
                    } catch (notificationError) {
                        console.warn('âš ï¸ Notification permission error:', notificationError.message);
                    }
                } else {
                    console.warn('âš ï¸ Notifications not supported');
                }

                // Store permissions status
                localStorage.setItem('luxbyte_permissions', JSON.stringify(permissions));
                console.log('ğŸ’¾ Permissions saved:', permissions);

            } catch (error) {
                console.error('âŒ Error requesting permissions:', error);
                LUXBYTE.notifyErr('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø·Ù„Ø¨ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª');
            }
        }

        // Check if camera is available
        async function checkCameraAvailability() {
            try {
                console.log('ğŸ” Checking camera availability...');

                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    console.warn('âš ï¸ MediaDevices API not supported');
                    return false;
                }

                // Check if we can enumerate devices
                const devices = await navigator.mediaDevices.enumerateDevices();
                console.log('ğŸ“± Available devices:', devices.length);

                const hasCamera = devices.some(device => device.kind === 'videoinput');
                console.log('ğŸ“¸ Camera available:', hasCamera);

                if (!hasCamera) {
                    console.warn('âš ï¸ No camera found on this device');
                    LUXBYTE.notifyWarn('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ§Ù…ÙŠØ±Ø§ Ù…ØªØ§Ø­Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²');
                    return false;
                }

                // Test if we can actually access the camera
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'environment' }
                    });
                    stream.getTracks().forEach(track => track.stop());
                    console.log('âœ… Camera access test successful');
                    return true;
                } catch (accessError) {
                    console.warn('âš ï¸ Camera access test failed:', accessError.message);
                    LUXBYTE.notifyWarn('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ - ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª');
                    return false;
                }

            } catch (error) {
                console.error('âŒ Error checking camera availability:', error);
                LUXBYTE.notifyErr('Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§');
                return false;
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('ğŸš€ LUXBYTE Unified Signup Page Loaded');

                // Request permissions first
                await requestPermissions();

                // Check camera availability
                const cameraAvailable = await checkCameraAvailability();
                if (!cameraAvailable) {
                    LUXBYTE.notifyWarn('Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØºÙŠØ± Ù…ØªØ§Ø­Ø© - Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„ØªØµÙˆÙŠØ± Ø§Ù„Ù…Ø¨Ø§Ø´Ø±');
                }

                // Get role from URL parameter
                const urlParams = new URLSearchParams(window.location.search);
                selectedRole = urlParams.get('role');
                console.log('ğŸ¯ Selected role from URL:', selectedRole);
                console.log('ğŸ“‹ Available roles:', Object.keys(window.CONFIG.ROLES));

                // If no role from URL, try to get from localStorage or default
                if (!selectedRole) {
                    selectedRole = localStorage.getItem('selectedRole') || 'restaurant';
                    console.log('ğŸ”„ Using fallback role:', selectedRole);
                }

                if (!selectedRole || !window.CONFIG.ROLES[selectedRole]) {
                    LUXBYTE.notifyErr('Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø· ØºÙŠØ± ØµØ­ÙŠØ­');
                    window.location.href = 'choose-role.html';
                    return;
                }

                // Update page header with role info
                const roleConfig = window.CONFIG.ROLES[selectedRole];
                const pageDescription = document.getElementById('page-description');
                if (pageDescription) {
                    pageDescription.textContent = `ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ${roleConfig.name}`;
                }

                // Setup form
                setupForm();

                // Setup GPS location
                setupGPSLocation();

                // Initialize common elements
                applyI18n();

                // Generate file upload fields after role is determined
                console.log('ğŸš€ Generating file upload fields after role determination...');
                console.log('ğŸ” Debug info:', {
                    selectedRole,
                    hasConfig: !!window.CONFIG,
                    hasRoles: !!(window.CONFIG && window.CONFIG.ROLES),
                    roleConfig: window.CONFIG && window.CONFIG.ROLES ? window.CONFIG.ROLES[selectedRole] : null
                });

                if (selectedRole && window.CONFIG && window.CONFIG.ROLES && window.CONFIG.ROLES[selectedRole]) {
                    generateFileUploadFields();
                } else {
                    console.error('âŒ Cannot generate file upload fields - missing role or config');
                    LUXBYTE.notifyErr('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø· - ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©');

                    // Try again after a short delay
                    setTimeout(() => {
                        if (selectedRole && window.CONFIG && window.CONFIG.ROLES && window.CONFIG.ROLES[selectedRole]) {
                            console.log('ğŸ”„ Retrying file upload generation...');
                            generateFileUploadFields();
                        }
                    }, 1000);
                }

            } catch (error) {
                console.error('âŒ Error during page initialization:', error);
                LUXBYTE.notifyErr('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.');
            }
        });

        // Setup form
        function setupForm() {
            const form = document.getElementById('signupForm');
            if (!form) return;

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('ğŸ“ Form submitted');

                try {
                    // Show loading
                    const submitBtn = form.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
                    submitBtn.disabled = true;

                    // Get form data
                    const formData = new FormData(form);
                    const email = formData.get('email');
                    const password = (formData.get('password') ?? '').toString();
                    const confirmPassword = (formData.get('confirm_password') ?? '').toString();

                    // Password validation
                    const stripBidi = (s) => s.replace(/[\u200E\u200F\u061C]/g, '').normalize('NFC');
                    const passwordClean = stripBidi(password);
                    const confirmClean = stripBidi(confirmPassword);

                    if (!passwordClean || !confirmClean) {
                        throw new Error('Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØ§Ù„ØªØ£ÙƒÙŠØ¯');
                    }

                    if (passwordClean !== confirmClean) {
                        throw new Error('ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©');
                    }

                    // Get account type
                    const accountType = formData.get('account_type');
                    if (!accountType) {
                        throw new Error('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨');
                    }

                    // Create user account using new auth system
                    await handleRegister(email, passwordClean, accountType, {
                        phone: formData.get('phone'),
                        business_name: formData.get('business_name'),
                        city: formData.get('city'),
                        governorate: formData.get('governorate')
                    });

                    // Registration successful - user will be redirected by handleRegister
                    LUXBYTE.notifyOk('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­! Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡...');

                } catch (error) {
                    console.error('âŒ Signup error:', error);
                    LUXBYTE.notifyErr(error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨');
                } finally {
                    // Reset button
                    const submitBtn = form.querySelector('button[type="submit"]');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            });
        }

        // Setup GPS location
        function setupGPSLocation() {
            console.log('ğŸ—ºï¸ Setting up GPS location...');
            const getLocationBtn = document.getElementById('getLocationBtn');
            const addressField = document.getElementById('address');
            const locationStatus = document.getElementById('locationStatus');

            if (!getLocationBtn) {
                console.error('âŒ GPS button not found!');
                return;
            }

            getLocationBtn.addEventListener('click', async () => {
                console.log('GPS button clicked!');
                if (!navigator.geolocation) {
                    locationStatus.innerHTML = '<span style="color: #ef4444;"><i class="fas fa-exclamation-triangle"></i> Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS</span>';
                    LUXBYTE.notifyErr('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS');
                    return;
                }

                locationStatus.innerHTML = '<span style="color: #6b7280;"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹...</span>';
                getLocationBtn.disabled = true;
                getLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ...';

                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 15000,
                            maximumAge: 300000
                        });
                    });

                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    console.log('Location obtained:', { lat, lng });

                    await getAddressFromCoordinates(lat, lng);
                    locationStatus.innerHTML = `<span style="color: #10b981;"><i class="fas fa-check"></i> ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${lat.toFixed(6)}, ${lng.toFixed(6)}</span>`;
                    LUXBYTE.notifyOk('ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­');

                } catch (error) {
                    console.error('GPS Error:', error);
                    let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
                    let errorIcon = 'fas fa-exclamation-triangle';

                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'ØªÙ… Ø±ÙØ¶ Ø¥Ø°Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­';
                            errorIcon = 'fas fa-ban';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ GPS';
                            errorIcon = 'fas fa-map-marker-slash';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø·Ù„Ø¨. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
                            errorIcon = 'fas fa-clock';
                            break;
                    }

                    locationStatus.innerHTML = `<span style="color: #ef4444;"><i class="${errorIcon}"></i> ${errorMessage}</span>`;
                    LUXBYTE.notifyErr(errorMessage);
                } finally {
                    getLocationBtn.disabled = false;
                    getLocationBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
                }
            });
        }

        // Get address from coordinates
        async function getAddressFromCoordinates(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ar`);
                const data = await response.json();

                if (data && data.display_name) {
                    const addressField = document.getElementById('address');
                    if (addressField) {
                        addressField.value = data.display_name;
                        console.log('Address set:', data.display_name);
                    }
                }
            } catch (error) {
                console.error('Error getting address:', error);
            }
        }

        // Generate file upload fields using the new unified system
        function generateFileUploadFields() {
            console.log('ğŸ”§ Starting generateFileUploadFields with unified system...');
            console.log('ğŸ¯ Current selectedRole:', selectedRole);

            // Use the new unified file upload system
            if (typeof window.generateFileUploadFields === 'function') {
                window.generateFileUploadFields(selectedRole);
            } else {
                console.error('âŒ Unified file upload system not loaded');
                LUXBYTE.notifyErr('Ù†Ø¸Ø§Ù… Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ØºÙŠØ± Ù…ØªØ§Ø­');
            }
        }

        // Handle file upload
        function handleFileUpload(event, fileConfig, container) {
            const file = event.target.files[0];
            if (!file) {
                console.log('No photo selected');
                return;
            }

            console.log('ğŸ“¸ Photo selected:', {
                name: file.name,
                size: file.size,
                type: file.type,
                lastModified: new Date(file.lastModified).toLocaleString()
            });

            if (!validateFile(file, fileConfig)) {
                return;
            }

            container.classList.add('uploaded');
            container.style.borderColor = '#10b981';
            container.style.background = '#f0fdf4';

            const uploadText = container.querySelector('.upload-text');
            const uploadButton = container.querySelector('.upload-button');

            if (uploadText) {
                uploadText.innerHTML = `<i class="fas fa-check-circle" style="color: #10b981; margin-left: 8px;"></i>ØªÙ… ØªØµÙˆÙŠØ±: ${fileConfig.label}`;
            }

            if (uploadButton) {
                uploadButton.innerHTML = `<i class="fas fa-check"></i>ØªÙ… Ø§Ù„ØªØµÙˆÙŠØ±`;
                uploadButton.style.background = '#10b981';
            }

            // Add file info
            const fileInfo = document.createElement('div');
            fileInfo.className = 'file-info';
            fileInfo.style.cssText = `margin-top: 12px; padding: 12px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; font-size: 14px; color: #065f46;`;
            fileInfo.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span><strong>Ø§Ù„Ù…Ù„Ù:</strong> ${file.name}</span>
                    <span><strong>Ø§Ù„Ø­Ø¬Ù…:</strong> ${LUXBYTE.formatFileSize(file.size)}</span>
                </div>
                <div style="margin-top: 8px;">
                    <button type="button" onclick="removeFile('${fileConfig.name}', this)" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">
                        <i class="fas fa-trash"></i> Ø¥Ø²Ø§Ù„Ø©
                    </button>
                </div>
            `;

            const existingInfo = container.querySelector('.file-info');
            if (existingInfo) {
                existingInfo.remove();
            }
            container.appendChild(fileInfo);

            uploadedFiles[fileConfig.name] = file;
            console.log('âœ… Photo uploaded successfully:', fileConfig.name);

            // Show image preview
            if (file.type.startsWith('image/')) {
                showImagePreview(file, container);
            }

            LUXBYTE.notifyOk(`ØªÙ… ØªØµÙˆÙŠØ± ${fileConfig.label} Ø¨Ù†Ø¬Ø§Ø­`);
        }

        // Show image preview
        function showImagePreview(file, container) {
            console.log('ğŸ–¼ï¸ Showing image preview for:', file.name);
            const reader = new FileReader();
            reader.onload = function(e) {
                // Remove existing preview
                const existingPreview = container.querySelector('.image-preview');
                if (existingPreview) {
                    existingPreview.remove();
                }

                // Create new preview
                const preview = document.createElement('div');
                preview.className = 'image-preview';
                preview.style.cssText = `
                    margin-top: 12px;
                    text-align: center;
                `;
                preview.innerHTML = `
                    <img src="${e.target.result}" style="
                        width: 100%;
                        max-width: 200px;
                        height: auto;
                        border-radius: 8px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        border: 2px solid #10b981;
                    " alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©">
                    <div style="
                        margin-top: 8px;
                        font-size: 12px;
                        color: #10b981;
                        font-weight: 500;
                    ">âœ“ ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­</div>
                `;

                container.appendChild(preview);
                console.log('âœ… Image preview displayed');
            };
            reader.readAsDataURL(file);
        }

        // Validate file
        function validateFile(file, fileConfig) {
            console.log('ğŸ” Validating file:', {
                name: file.name,
                type: file.type,
                size: file.size,
                lastModified: new Date(file.lastModified).toLocaleString()
            });

            // Only accept images (camera photos)
            if (!file.type.startsWith('image/')) {
                console.log('âŒ Invalid image type:', file.type);
                LUXBYTE.notifyErr('ÙŠØ±Ø¬Ù‰ ØªØµÙˆÙŠØ± Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ - Ø§Ù„ØµÙˆØ± ÙÙ‚Ø· Ù…Ø³Ù…ÙˆØ­Ø©');
                return false;
            }

            const maxSize = 10 * 1024 * 1024; // 10MB for camera photos
            if (file.size > maxSize) {
                console.log('âŒ File too large:', file.size, 'Max:', maxSize);
                LUXBYTE.notifyErr('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ - Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 10 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª');
                return false;
            }

            console.log('âœ… File validation passed');
            return true;
        }

        // Remove file
        function removeFile(fileName, buttonElement) {
            console.log('Removing photo:', fileName);
            delete uploadedFiles[fileName];

            const container = buttonElement.closest('.file-upload');
            if (container) {
                container.classList.remove('uploaded');
                container.style.borderColor = '#d1d5db';
                container.style.background = '#fafbfc';

                const uploadText = container.querySelector('.upload-text');
                const uploadButton = container.querySelector('.upload-button');

                if (uploadText) {
                    uploadText.innerHTML = `Ø§Ø¶ØºØ· Ù„ØªØµÙˆÙŠØ± ${fileName}`;
                }

                if (uploadButton) {
                    uploadButton.innerHTML = `<i class="fas fa-camera"></i>ØªØµÙˆÙŠØ± Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§`;
                    uploadButton.style.background = '#3b82f6';
                }

                const fileInfo = container.querySelector('.file-info');
                if (fileInfo) {
                    fileInfo.remove();
                }

                const fileInput = container.querySelector('.file-input');
                if (fileInput) {
                    fileInput.value = '';
                }
            }

            LUXBYTE.notifyOk('ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©');
        }

        // Upload photos to Supabase Storage
        async function uploadFiles(userId, businessId) {
            const roleConfig = window.CONFIG.ROLES[selectedRole];
            const bucket = roleConfig.bucket;

            for (const [fileName, file] of Object.entries(uploadedFiles)) {
                try {
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${userId}/${businessId}/${fileName}.${fileExt}`;

                    const { data, error } = await LUXBYTE.supabase.storage
                        .from(bucket)
                        .upload(fileName, file);

                    if (error) throw error;
                    console.log('Photo uploaded to storage:', fileName);
                } catch (error) {
                    console.error('Error uploading photo:', fileName, error);
                    LUXBYTE.notifyErr(`ÙØ´Ù„ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©: ${fileName}`);
                }
            }
        }

        // Test function for file upload generation
        function testFileUploadGeneration() {
            console.log('ğŸ§ª Testing file upload generation...');
            console.log('ğŸ” Current state:', {
                selectedRole,
                hasConfig: !!window.CONFIG,
                hasRoles: !!(window.CONFIG && window.CONFIG.ROLES),
                roleConfig: window.CONFIG && window.CONFIG.ROLES ? window.CONFIG.ROLES[selectedRole] : null
            });

            if (selectedRole && window.CONFIG && window.CONFIG.ROLES && window.CONFIG.ROLES[selectedRole]) {
                generateFileUploadFields();
                LUXBYTE.notifyOk('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±');
            } else {
                LUXBYTE.notifyErr('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± - ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·');
            }
        }

        // Test file upload functionality
        async function testFileUploadFunctionality() {
            console.log('ğŸ“ Testing file upload functionality...');
            LUXBYTE.notifyInfo('Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±...');

            try {
                // Create a test file input
                const testInput = document.createElement('input');
                testInput.type = 'file';
                testInput.accept = 'image/*';
                testInput.style.display = 'none';
                document.body.appendChild(testInput);

                return new Promise((resolve) => {
                    testInput.addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        if (file) {
                            if (file.type.startsWith('image/')) {
                                console.log('âœ… File upload test successful');
                                LUXBYTE.notifyOk('âœ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­!');
                                resolve(true);
                            } else {
                                console.log('âŒ Invalid file type');
                                LUXBYTE.notifyErr('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ØµÙˆØ±Ø© ØµØ§Ù„Ø­');
                                resolve(false);
                            }
                        } else {
                            console.log('âŒ No file selected');
                            LUXBYTE.notifyErr('Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ù…Ù„Ù');
                            resolve(false);
                        }
                        document.body.removeChild(testInput);
                    });

                    testInput.click();
                });

            } catch (error) {
                console.error('âŒ File upload test failed:', error);
                LUXBYTE.notifyErr(`Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±: ${error.message}`);
                return false;
            }
        }

        // Logout function
        async function logout() {
            try {
                await LUXBYTE.supabase.auth.signOut();
                LUXBYTE.notifyOk('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            } catch (error) {
                console.error('Logout error:', error);
                LUXBYTE.notifyErr('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
            }
        }

        // Make functions available globally for onclick handlers
        window.logout = logout;
        window.testFileUploadGeneration = testFileUploadGeneration;
        window.testFileUploadFunctionality = testFileUploadFunctionality;
        window.removeFile = removeFile;
    </script>

    <!-- Core Scripts - Load in correct order -->
    <script src="config.js" defer></script>
    <script type="module" src="src/utils/env.js"></script>
    <script type="module" src="js/supabase-client.js"></script>
    <script type="module" src="js/file-upload-manager.js"></script>
    <script type="module" src="js/signup-init.js"></script>

    <!-- Auth and Guard Scripts -->
    <script type="module" src="js/auth.js"></script>
    <script type="module" src="js/guard.js"></script>

    <!-- Camera Upload Manager -->
    <script type="module">
        import { openCamera, captureAndUpload, onFallbackFile, stopStream } from './js/camera-upload-manager.js';

        // Make functions available globally for onclick handlers
        window.openCamera = openCamera;
        window.captureAndUpload = captureAndUpload;
        window.onFallbackFile = onFallbackFile;
        window.stopStream = stopStream;

        // Show camera controls when page loads
        document.addEventListener('DOMContentLoaded', () => {
            const cameraControls = document.getElementById('camera-controls');
            if (cameraControls) {
                cameraControls.style.display = 'block';
            }
        });
    </script>

    <!-- New Bootstrap System -->
    <script type="module" src="src/pages/unified-signup.js"></script>

    <!-- Legacy Unified Signup Initializer (for backward compatibility) -->
    <script type="module" src="js/unified-signup-init.js"></script>

    <!-- Hotfix: Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø³Ø¨ÙŠÙ†Ø± Ø¨Ø¹Ø¯ 2 Ø«Ø§Ù†ÙŠØ© Ù…Ù‡Ù…Ø§ Ø­Ø¯Ø« -->
    <script type="module">
        // Watchdog: Ù„Ø§ ÙŠÙØ¶Ù„ Ø§Ù„Ø³Ø¨ÙŠÙ†Ø± Ø£ÙƒØªØ± Ù…Ù† 2Ø«
        function stopSpinner(){
            const sp = document.getElementById('uploadButtonsSpinner');
            if (sp) sp.style.display = 'none';
            console.log('ğŸ”„ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø³Ø¨ÙŠÙ†Ø± (watchdog)');
        }

        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø³Ø¨ÙŠÙ†Ø± Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ† Ù…Ù‡Ù…Ø§ Ø­Ø¯Ø«
        setTimeout(stopSpinner, 2000);

        // Ø¨Ù†Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø³ÙŠØ·Ø© ÙÙˆØ±Ø§Ù‹
        function buildSimpleUI() {
            const c = document.getElementById('uploadButtonsContainer');
            if (!c) return;

            const role = new URLSearchParams(location.search).get('role') || 'pharmacy';
            const docs = {
                pharmacy: ['commercial_register', 'tax_card', 'pharmacy_license'],
                supermarket: ['commercial_register', 'tax_card', 'business_license'],
                restaurant: ['commercial_register', 'tax_card', 'food_license'],
                clinic: ['commercial_register', 'tax_card', 'medical_license'],
                courier: ['national_id_front', 'national_id_back', 'driving_license'],
                driver: ['driver_license', 'car_license', 'car_photos']
            }[role] || ['commercial_register', 'tax_card'];

            c.innerHTML = '';
            for (const doc of docs) {
                const label = {
                    commercial_register: 'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ',
                    tax_card: 'Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠØ©',
                    pharmacy_license: 'ØªØ±Ø®ÙŠØµ Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©',
                    business_license: 'Ø±Ø®ØµØ© Ø§Ù„Ù†Ø´Ø§Ø·',
                    food_license: 'Ø±Ø®ØµØ© Ø§Ù„Ø·Ø¹Ø§Ù…',
                    medical_license: 'Ø§Ù„ØªØ±Ø®ÙŠØµ Ø§Ù„Ø·Ø¨ÙŠ',
                    national_id_front: 'Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© (Ø£Ù…Ø§Ù…)',
                    national_id_back: 'Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© (Ø®Ù„Ù)',
                    driving_license: 'Ø±Ø®ØµØ© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©',
                    car_license: 'Ø±Ø®ØµØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø©',
                    car_photos: 'ØµÙˆØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø©'
                }[doc] || doc;

                c.insertAdjacentHTML('beforeend', `
                    <div class="file-upload-field">
                        <div class="file-upload-label">
                            <label>${label}</label>
                            <p class="file-description">JPG, PNG Ø£Ùˆ PDF (Ø­Ø¯ Ø£Ù‚ØµÙ‰ 10 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª)</p>
                        </div>
                        <div class="file-upload-controls">
                            <button id="btn_${doc}" type="button" class="upload-btn">
                                <i class="fas fa-camera"></i> ØªØµÙˆÙŠØ±/Ø±ÙØ¹
                            </button>
                            <input id="file_${doc}" type="file" accept="image/*" capture="environment" hidden>
                        </div>
                        <img id="preview_${doc}" style="display:none;max-width:100%;margin-top:8px;border-radius:8px;" alt="Ù…Ø¹Ø§ÙŠÙ†Ø©">
                    </div>
                `);

                // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
                const btn = document.getElementById(`btn_${doc}`);
                const inp = document.getElementById(`file_${doc}`);
                const img = document.getElementById(`preview_${doc}`);

                btn.onclick = () => inp.click();
                inp.onchange = (e) => {
                    const f = e.target.files?.[0];
                    if (!f) return;
                    const url = URL.createObjectURL(f);
                    img.src = url;
                    img.style.display = 'block';
                    console.log(`ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù: ${f.name} (${doc})`);
                };
            }
        }

        // Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ Ø¨Ù†Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø³ÙŠØ·Ø©...');
            buildSimpleUI();
        });
    </script>

    <!-- Firebase Setup with Analytics -->
    <script type="module" src="firebase-app.js"></script>
</body>
</html>
